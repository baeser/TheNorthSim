<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The North - Pre-WWI Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #f3f0e9; /* Parchment-like color */
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><g fill-opacity="0.05"><rect x="50" width="50" height="50" /><rect y="50" width="50" height="50" /></g></svg>');
        }
        h1, h2, h3, h4, h5, h6 { font-family: 'Cinzel', serif; }
        
        .card { @apply bg-white/80 backdrop-blur-sm rounded-xl shadow-lg transition-all duration-300 border border-black/10 hover:shadow-2xl; }
        
        .btn { @apply px-6 py-2 rounded-lg font-bold text-white shadow-md transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 hover:-translate-y-0.5; }
        .btn-primary { @apply bg-gradient-to-br from-indigo-600 to-indigo-800 hover:from-indigo-700 hover:to-indigo-900; }
        .btn-secondary { @apply bg-gradient-to-br from-gray-600 to-gray-800 text-white hover:from-gray-700 hover:to-gray-900; }
        .btn-danger { @apply bg-gradient-to-br from-red-600 to-red-800 hover:from-red-700 hover:to-red-900; }
        .btn-success { @apply bg-gradient-to-br from-green-600 to-green-800 hover:from-green-700 hover:to-green-900; }
        .btn-warning { @apply bg-gradient-to-br from-yellow-500 to-yellow-700 text-black hover:from-yellow-600 hover:to-yellow-800; }

        .info-box { @apply bg-white/70 p-4 rounded-lg text-center shadow-md border border-black/10; }
        .modal-backdrop { @apply fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50; }
        
        .tab-btn { @apply cursor-pointer py-4 px-6 border-b-4 font-semibold text-gray-500 border-transparent hover:text-gray-900 hover:border-gray-300 whitespace-nowrap transition-colors duration-200; }
        .tab-btn.active { @apply border-indigo-700 text-indigo-800; }
        .tab-panel { @apply hidden; }
        .tab-panel.active { @apply block; }

        #studentCountryBanner h1 {
            font-family: 'Cinzel Decorative', cursive;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="connectionStatus" class="fixed top-4 right-4 text-white text-sm font-bold py-1 px-3 rounded-full z-50 bg-yellow-500">Connecting...</div>

    <div id="loginScreen" class="fixed inset-0 bg-cover bg-center z-40 flex items-center justify-center p-4" style="background-image: url('https://placehold.co/1920x1080/2c3e50/ecf0f1?text=The+North');">
        <div class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl w-full max-w-md text-center backdrop-blur-sm">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome to The North</h2>
            <p class="text-gray-600 mb-6">A game of national pride and international power.</p>
            <button id="signInBtn" class="btn btn-primary w-full text-lg py-3 flex items-center justify-center gap-3">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.861 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                Sign In with Google
            </button>
            <p id="loginError" class="text-red-500 mt-4 font-semibold"></p>
        </div>
    </div>

    <div id="rosterScreen" class="hidden fixed inset-0 bg-gray-200 z-30 flex items-center justify-center p-4">
        <div class="card p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Manage Student Roster</h2>
                <div class="text-sm text-gray-600">Class Code: <span id="rosterClassCode" class="font-semibold"></span></div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-3">Add Students</h3>
                
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-medium text-blue-800 mb-2">CSV Upload (Recommended for large classes)</h4>
                    <p class="text-sm text-blue-700 mb-3">Upload a CSV file with columns: Email, Country, Section (optional)</p>
                    <div class="flex items-center gap-4 mb-2">
                        <input type="file" id="csvFile" accept=".csv" class="px-3 py-2 border border-blue-300 rounded-lg">
                        <button onclick="uploadCSV()" class="btn btn-primary">Upload CSV</button>
                        <button onclick="downloadTemplate()" class="btn btn-secondary text-sm">Download Template</button>
                    </div>
                    <p class="text-xs text-blue-600">CSV format: student1@email.com,Tobermory,2A or student1@email.com,Tobermory</p>
                    <p class="text-xs text-blue-600">Multiple students can be assigned to the same country (teams)</p>
                </div>

                <div class="p-4 bg-gray-100 border border-gray-200 rounded-lg">
                    <h4 class="font-medium text-gray-700 mb-2">Manual Entry (Single Student)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="email" id="studentEmail" placeholder="Student email address" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <select id="studentCountry" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Select Country --</option>
                            <option value="Tobermory">Tobermory ($100,000)</option>
                            <option value="Metz">Metz ($100,000)</option>
                            <option value="Omsk">Omsk ($75,000)</option>
                            <option value="Grenoble">Grenoble ($60,000)</option>
                            <option value="Klagenfurt">Klagenfurt ($50,000)</option>
                            <option value="Tivoli">Tivoli ($40,000)</option>
                            <option value="Razgrad">Razgrad ($25,000)</option>
                        </select>
                        <select id="studentPeriod" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Select Period --</option>
                            <option value="1">Period 1</option>
                            <option value="2">Period 2</option>
                            <option value="3">Period 3</option>
                            <option value="4">Period 4</option>
                            <option value="5">Period 5</option>
                            <option value="6">Period 6</option>
                            <option value="7">Period 7</option>
                            <option value="8">Period 8</option>
                            <option value="9">Period 9</option>
                            <option value="10">Period 10</option>
                            <option value="11">Period 11</option>
                            <option value="12">Period 12</option>
                        </select>
                        <button onclick="addStudentToRoster()" class="btn btn-primary">Add Student</button>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">Current Roster</h3>
                    <button id="removeSelectedBtn" type="button" onclick="removeSelectedStudents()" class="btn btn-danger">Remove Selected</button>
                </div>
                <form id="rosterForm">
                    <div id="rosterList" class="space-y-2 min-h-[200px] max-h-[300px] overflow-y-auto border border-gray-200 rounded-lg p-4 bg-white">
                        <p class="text-gray-500 text-center">No students added yet</p>
                    </div>
                </form>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Class Period Breakdown</h3>
                <div id="periodBreakdown" class="space-y-4">
                    </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Class Period to Start:</label>
                        <select id="classPeriodSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Select Period --</option>
                        </select>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="startSimulationDirectly()" class="btn btn-success flex-grow">Start Simulation</button>
                        <button onclick="clearAllRoster()" class="btn btn-danger">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="classCodeScreen" class="hidden fixed inset-0 bg-gray-200 z-30 flex items-center justify-center p-4">
        <div class="card p-8 w-full max-w-sm text-center">
             <h2 class="text-2xl font-bold text-gray-800 mb-4">Enter Class Code</h2>
             <input type="text" id="classCodeInput" placeholder="e.g., HISTORY101" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 uppercase">
             <button id="joinClassBtn" class="btn btn-primary w-full mt-4">Join / Create Simulation</button>
             <p id="classCodeError" class="text-red-500 mt-4 font-semibold"></p>
        </div>
    </div>

    <div id="gameContainer" class="hidden p-4 lg:p-6 max-w-7xl mx-auto">
        <div id="studentCountryBanner" class="hidden w-full h-48 lg:h-64 mb-6 rounded-xl shadow-2xl bg-cover bg-center flex items-center justify-center text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-black/40"></div>
            <div id="bannerContent" class="z-10 flex items-center gap-4 lg:gap-8">
                <div id="bannerEmblem" class="w-16 h-16 lg:w-24 lg:h-24">
                </div>
                <h1 id="bannerCountryName" class="text-5xl md:text-7xl font-bold">Country Name</h1>
            </div>
        </div>
        
        <header id="mainHeader" class="card p-4 mb-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-indigo-900">The North</h1>
                    <p class="text-gray-500">Class: <span id="displayClassCode" class="font-semibold"></span> | Player: <span id="displayPlayerName" class="font-semibold text-indigo-700"></span></p>
                </div>
                <div id="phaseIndicator" class="text-center bg-gray-500 text-white rounded-full px-6 py-2">
                    <div class="font-bold text-lg">Round <span id="currentRound">1</span></div>
                    <div class="text-sm" id="phaseText">Waiting for Teacher...</div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="info-box"><div class="text-sm text-indigo-800 font-semibold">Budget ($)</div><div id="countryBudget" class="text-xl font-bold text-indigo-900">0</div></div>
            <div class="info-box"><div class="text-sm text-indigo-800 font-semibold">Income / Round</div><div id="roundIncome" class="text-xl font-bold text-indigo-900">0</div></div>
            <div class="info-box"><div class="text-sm text-indigo-800 font-semibold">Army Units</div><div id="armyUnits" class="text-xl font-bold text-indigo-900">0</div></div>
            <div class="info-box"><div class="text-sm text-indigo-800 font-semibold">Navy Units</div><div id="navyUnits" class="text-xl font-bold text-indigo-900">0</div></div>
            <div class="info-box"><div class="text-sm text-indigo-800 font-semibold">Happiness</div><div id="happinessTopDisplay" class="text-xl font-bold text-indigo-900">100</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="studentColumn" class="lg:col-span-2 space-y-6">
                <div id="studentRoleInterface" class="card hidden">
                    <div class="border-b border-gray-200">
                        <nav id="roleTabs" class="flex flex-wrap -mb-px px-6 overflow-x-auto" aria-label="Tabs">
                        </nav>
                    </div>
                    <div id="roleTabContent" class="p-6">
                    </div>
                </div>

                <div id="actionCardTemplates" class="hidden">
                    <div id="treasuryCardTemplate">
                        <div class="card p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">National Treasury</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                <div class="info-box bg-blue-100 p-4">
                                    <div class="text-sm text-blue-800 font-semibold">Total Country Budget</div>
                                    <div id="treasuryTotalBudget" class="text-2xl font-bold text-blue-900">$0</div>
                                </div>
                                <div class="info-box bg-red-100 p-4">
                                    <div class="text-sm text-red-800 font-semibold">Allocated Military Budget</div>
                                    <div id="treasuryMilitaryBudget" class="text-2xl font-bold text-red-900">$0</div>
                                </div>
                            </div>
                            <div class="mt-6">
                                <label for="militaryBudgetSlider" class="block font-medium text-gray-700">Military Budget Allocation: <span id="militaryBudgetPercentageDisplay" class="font-bold text-indigo-600">25%</span></label>
                                <input type="range" id="militaryBudgetSlider" min="0" max="100" value="25" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="setMilitaryBudget(this.value)">
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Colonial Investment Planning</h3>
                            <p class="text-sm text-gray-600 mb-4">Pay now to attempt colonization. Results are revealed by the teacher at the end of the round.</p>
                            <div id="colonialPlanning" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                </div>
                        </div>
                    </div>
                    <div id="militaryCardTemplate">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Department of War</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-center">
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-red-800">Total Military Budget</h4>
                                    <p id="warTotalBudget" class="text-2xl font-bold text-red-900">$0</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800">Remaining Funds</h4>
                                    <p id="warRemainingBudget" class="text-2xl font-bold text-green-900">$0</p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                    <div>
                                        <div class="font-bold text-lg">Army Regiment</div>
                                        <div class="text-sm text-gray-600">Cost: 750 $ per unit</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="armyQuantity-main" min="1" value="1" class="w-20 text-center border-gray-300 rounded-md">
                                        <button onclick="purchaseUnits('army', 'main')" class="btn btn-danger flex-grow">Purchase</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                    <div>
                                        <div class="font-bold text-lg">Naval Fleet</div>
                                        <div class="text-sm text-gray-600">Cost: 1000 $ per unit</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="navyQuantity-main" min="1" value="1" class="w-20 text-center border-gray-300 rounded-md">
                                        <button onclick="purchaseUnits('navy', 'main')" class="btn btn-danger flex-grow">Purchase</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end of #militaryCardTemplate -->

                    <div id="warDeclarationTemplate">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Department of War - Military Operations</h3>
                            
                            <!-- Regular purchase interface (existing) -->
                            <div id="warPurchaseInterface">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-center">
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-red-800">Total Military Budget</h4>
                                        <p id="warTotalBudget-war" class="text-2xl font-bold text-red-900">$0</p>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-green-800">Remaining Funds</h4>
                                        <p id="warRemainingBudget-war" class="text-2xl font-bold text-green-900">$0</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                        <div>
                                            <div class="font-bold text-lg">Army Regiment</div>
                                            <div class="text-sm text-gray-600">Cost: 750 $ per unit</div>
                                        </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="armyQuantity-war" min="1" value="1" class="w-20 text-center border-gray-300 rounded-md">
                                        <button onclick="purchaseUnits('army', 'war')" class="btn btn-danger flex-grow">Purchase</button>
                                    </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                        <div>
                                            <div class="font-bold text-lg">Naval Fleet</div>
                                            <div class="text-sm text-gray-600">Cost: 1000 $ per unit</div>
                                        </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="navyQuantity-war" min="1" value="1" class="w-20 text-center border-gray-300 rounded-md">
                                        <button onclick="purchaseUnits('navy', 'war')" class="btn btn-danger flex-grow">Purchase</button>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- War Declaration Interface (only shows after round 4) -->
                            <div id="warDeclarationInterface" class="hidden mt-6 pt-6 border-t-2 border-red-300">
                                <div class="bg-red-900 text-white p-4 rounded-lg mb-4">
                                    <h4 class="text-lg font-bold mb-2">⚔️ MILITARY AGGRESSION AUTHORIZED ⚔️</h4>
                                    <p class="text-sm">You may now declare war on rival alliances. Approval required from Secretary of State and Minister of Domestic Tranquility.</p>
                                </div>
                                <button onclick="showWarDeclarationModal()" class="btn btn-danger w-full text-lg py-4 bg-gradient-to-br from-red-700 to-red-900 hover:from-red-800 hover:to-black">
                                    DECLARE WAR
                                </button>
                                
                                <!-- Show pending war declarations -->
                                <div id="pendingWarDeclarations" class="mt-4 hidden">
                                    <h5 class="font-semibold text-gray-700 mb-2">Pending War Declarations (Awaiting Approval):</h5>
                                    <div id="pendingWarList" class="space-y-2">
                                        <!-- Populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add approval interfaces for Secretary of State and Minister -->
                    <div id="warApprovalTemplate">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">War Declaration Approval</h3>
                            <div id="warApprovalContent">
                                <p class="text-gray-600 mb-4">You must approve any declarations of war from your country before they are finalized.</p>
                                <div class="war-approval-list space-y-3">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                            <div class="no-war-approvals text-gray-500 text-center py-8">
                                <p>No war declarations pending your approval.</p>
                            </div>
                        </div>
                    </div>
                    <div id="allianceCardTemplate">
                        <div class="card p-6">
                            <div id="allianceWarApprovalSection" class="hidden mb-6 border-2 border-red-300 pt-4 bg-red-50 p-4 rounded-lg">
                                <!-- War approval content will be injected here -->
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Alliances</h3>
                            <p class="text-sm text-gray-600 mb-4">Form alliances for mutual benefit. Beware of historical rivalries!</p>
                            <button class="btn btn-primary w-full" onclick="showAllianceModal()">Manage Alliances</button>
                            <div id="myAlliances" class="mt-4">
                                </div>
                        </div>
                    </div>
                    <div id="ministerCardTemplate">
                         <div class="card p-6 bg-gray-50">
                            <div id="ministerWarApprovalSection" class="hidden mb-6 border-2 border-red-300 pt-4 bg-red-50 p-4 rounded-lg">
                                <!-- War approval content will be injected here -->
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Minister of Domestic Tranquility</h3>
                            <p class="text-gray-600 mb-4">Your duty is to manage national morale (PNP) and symbols of national pride.</p>
                             <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-semibold">Happiness Index:</span>
                                    <span id="happinessDisplay" class="text-2xl font-bold text-blue-900">100</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div id="happinessBar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-4 rounded-full transition-all duration-500" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block font-medium text-gray-700 mb-2">
                                        Healthcare: <span id="healthcarePercent" class="font-bold text-indigo-600">20%</span>
                                        <span id="healthcareDollars" class="text-sm text-gray-600 ml-2">($0)</span>
                                    </label>
                                    <input type="range" id="healthcareSlider" min="0" max="50" value="20" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer" oninput="updateDomesticSpending()">
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block font-medium text-gray-700 mb-2">
                                        Education: <span id="educationPercent" class="font-bold text-indigo-600">20%</span>
                                        <span id="educationDollars" class="text-sm text-gray-600 ml-2">($0)</span>
                                    </label>
                                    <input type="range" id="educationSlider" min="0" max="50" value="20" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer" oninput="updateDomesticSpending()">
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label class="block font-medium text-gray-700 mb-2">
                                        Infrastructure: <span id="infrastructurePercent" class="font-bold text-indigo-600">20%</span>
                                        <span id="infrastructureDollars" class="text-sm text-gray-600 ml-2">($0)</span>
                                    </label>
                                    <input type="range" id="infrastructureSlider" min="0" max="50" value="20" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer" oninput="updateDomesticSpending()">
                                </div>
                            </div>
                            <div id="domesticWarnings" class="mt-4 space-y-2"></div>
                            <button onclick="saveDomesticBudget()" class="btn btn-success w-full mt-4">Save Domestic Budget</button>
                            
                            <div class="border-t pt-4 mt-4">
                                <h4 class="text-lg font-semibold text-gray-800 mb-3">Active National Events</h4>
                                <div id="activeEventsList" class="space-y-2 max-h-40 overflow-y-auto">
                                    <p class="text-gray-500">No active events.</p>
                                </div>
                            </div>

                            <div class="border-t pt-4 mt-4">
                                <h4 class="text-lg font-semibold text-gray-800 mb-3">National Flag</h4>
                                <div class="flex flex-col md:flex-row items-center gap-4">
                                    <div class="w-48 h-28 bg-gray-200 rounded-md flex items-center justify-center border-2 border-dashed">
                                        <img id="flagPreview" src="https://placehold.co/192x112/e2e8f0/94a3b8?text=No+Flag" alt="Flag preview" class="w-full h-full object-cover rounded-md">
                                    </div>
                                    <div class="flex-grow">
                                        <label for="flagUploader" class="block text-sm font-medium text-gray-700 mb-2">Select a new flag image (max 1MB):</label>
                                        <input type="file" id="flagUploader" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                                        <button id="uploadFlagBtn" onclick="uploadFlag()" class="btn btn-primary mt-3">Upload Flag</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div id="teacherPanel" class="card p-6 hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Teacher Controls</h3>
                    <div class="space-y-3">
                         <div class="text-center p-3 rounded-lg bg-indigo-50 border border-indigo-200">
                            <label for="timerMinutes" class="font-semibold text-indigo-800">Round Timer</label>
                            <div class="flex justify-center items-center gap-2 mt-1">
                                <input type="number" id="timerMinutes" value="15" min="1" class="w-20 text-center border-gray-300 rounded-md">
                                <span class="text-gray-600">minutes</span>
                            </div>
                        </div>
                        <button id="startRoundBtn" onclick="startRound()" class="btn btn-success w-full">1. Start Round</button>
                        <button id="endRoundBtn" onclick="endRound()" class="btn btn-warning w-full">2. End Round & Lock Actions</button>
                        <button id="colonialChanceBtn" onclick="resolveColonialChance()" class="btn btn-primary w-full">3. Resolve Colonial Chance</button>
                        <button id="checkAlliancesBtn" onclick="checkAlliances()" class="btn btn-primary w-full">4. Check Alliances</button>
                        <button id="nextRoundBtn" onclick="nextRound()" class="btn btn-success w-full bg-purple-600 hover:bg-purple-700">5. Advance to Next Round</button>
                        
                        <hr class="my-3">
                        <button onclick="showTeacherRoleEditor()" class="btn btn-secondary w-full">Edit Roles</button>
                        <button onclick="showPnpPanel()" class="btn btn-secondary w-full">Award/Deduct PNP</button>
                        <button onclick="exportResults()" class="btn btn-secondary w-full bg-teal-600 hover:bg-teal-700">Export Results (PDF)</button>
                        <button onclick="resetGame()" class="btn btn-danger w-full mt-4">Reset Full Game</button>
                    </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Country Log</h3>
                    <div id="eventLog" class="space-y-2 max-h-60 overflow-y-auto pr-2 text-sm">
                       <p class="text-gray-500">No events yet.</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Power Rankings</h3>
                    <div id="leaderboardList" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="warDeclarationModal" class="modal-backdrop hidden">
        <div class="card p-6 w-full max-w-2xl m-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-red-800 mb-4">⚔️ Declaration of War</h3>
            
            <div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4 mb-4">
                <p class="text-sm font-semibold text-yellow-800">⚠️ WARNING: This action will declare war on all selected nations!</p>
                <p class="text-xs text-yellow-700 mt-1">Requires unanimous approval from Secretary of State and Minister of Domestic Tranquility</p>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold text-gray-700 mb-2">Enemy Alliances:</h4>
                <div id="enemyAlliancesList" class="space-y-4">
                    <!-- Populated with enemy alliances -->
                </div>
            </div>
            
            <div class="mb-4">
                <label for="warJustification" class="block font-medium text-gray-700 mb-2">Justification for War (Optional):</label>
                <textarea id="warJustification" rows="3" placeholder="State your casus belli..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button class="btn btn-secondary" onclick="closeWarDeclarationModal()">Cancel</button>
                <button class="btn btn-danger" onclick="submitWarDeclaration()">Submit Declaration</button>
            </div>
        </div>
    </div>

    <div id="warNotificationModal" class="modal-backdrop hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center bg-red-50 border-4 border-red-600">
            <h3 class="text-3xl font-bold text-red-800 mb-4">⚔️ WAR DECLARED! ⚔️</h3>
            <div id="warNotificationContent" class="space-y-4">
                <!-- Populated dynamically -->
            </div>
            <button onclick="acknowledgeWarDeclaration()" class="btn btn-danger mt-6 w-full py-3 text-lg">
                Acknowledge Declaration
            </button>
        </div>
    </div>

    <div id="allianceModal" class="modal-backdrop hidden">
        <div class="card p-6 w-full max-w-lg m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Form an Alliance</h3>
            <p class="text-sm text-gray-600 mb-4">Select countries to form an alliance with. Forming an alliance is mutual.</p>
            <div id="countryCheckboxes" class="space-y-2 max-h-60 overflow-y-auto border p-3 rounded-lg"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button class="btn btn-secondary" onclick="closeAllianceModal()">Cancel</button>
                <button class="btn btn-success" onclick="proposeAlliance()">Confirm Alliances</button>
            </div>
        </div>
    </div>

    <div id="pnpPanel" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-red-900 text-white rounded-xl shadow-lg p-8 w-full max-w-2xl relative">
            <button onclick="closePnpPanel()" class="absolute top-4 right-4 text-gray-300 hover:text-white transition-colors">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-3xl font-bold mb-6 text-center">Award or Deduct PNP</h3>
            <div class="space-y-6">
                <div>
                    <label for="pnpCountry" class="block text-lg font-medium text-gray-200 mb-2">Select Country:</label>
                    <select id="pnpCountry" class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-black">
                        <option value="">-- Select a Country --</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                         <label for="pnpAmount" class="block text-lg font-medium text-gray-200 mb-2">Amount:</label>
                        <input type="number" id="pnpAmount" placeholder="e.g. 20 or -10" class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-black">
                    </div>
                     <div>
                        <label for="pnpReasonDropdown" class="block text-lg font-medium text-gray-200 mb-2">Reason Template:</label>
                        <select id="pnpReasonDropdown" class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-black" onchange="handleReasonChange()">
                            <option value="">-- Select a Reason --</option>
                            <option value="Citizen out of area">Citizen out of area</option>
                            <option value="Citizen on cell phone">Citizen on cell phone</option>
                            <option value="Citizen being annoying">Citizen being annoying</option>
                            <option value="Excellent diplomacy">Excellent diplomacy</option>
                            <option value="Good roleplay">Good roleplay</option>
                            <option value="Historical accuracy">Historical accuracy</option>
                            <option value="Leadership shown">Leadership shown</option>
                            <option value="Disruptive behavior">Disruptive behavior</option>
                            <option value="Out of character">Out of character</option>
                            <option value="Custom">Custom (enter below)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="pnpReason" class="block text-lg font-medium text-gray-200 mb-2">Final Reason:</label>
                    <input type="text" id="pnpReason" placeholder="Enter custom reason or edit selected reason" class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-black">
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button class="btn btn-danger text-lg px-8 py-3" onclick="closePnpPanel()">Cancel</button>
                <button class="btn btn-success text-lg px-8 py-3" onclick="awardPnpToCountry()">Submit</button>
            </div>
        </div>
    </div>
    
    <div id="hourSelectionModal" class="modal-backdrop hidden">
        <div class="card p-6 w-full max-w-md m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Select Class Hour</h3>
            <p class="text-sm text-gray-600 mb-4">Which class period are you teaching right now?</p>
            <div id="availableHours" class="space-y-2 mb-6">
                </div>
            <div class="flex justify-end gap-3">
                <button class="btn btn-secondary" onclick="closeHourSelection()">Cancel</button>
                <button class="btn btn-success" onclick="startSimulationWithHour()" id="startWithHourBtn" disabled>Start Simulation</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal-backdrop hidden">
        <div class="card p-6 w-full max-w-sm m-4 text-center">
            <h3 id="confirmModalTitle" class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p id="confirmModalBody" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="btn btn-secondary px-6">Cancel</button>
                <button id="confirmOkBtn" class="btn btn-danger px-6">Confirm</button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal-backdrop hidden">
        <div class="card p-6 w-full max-w-2xl m-4 max-h-[80vh] overflow-y-auto">
            <h3 id="infoModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Results</h3>
            <div id="infoModalBody" class="space-y-3"></div>
            <div class="mt-6 flex justify-end">
                <button class="btn btn-primary" onclick="closeInfoModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="studentNotificationModal" class="modal-backdrop hidden">
        <div class="card p-8 w-full max-w-md m-4 text-center transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="studentNotificationTitle" class="text-2xl font-bold text-gray-800 mb-4">Update from Teacher</h3>
            <div id="studentNotificationBody" class="text-lg text-gray-700 space-y-3">
            </div>
            <div class="mt-8">
                <button onclick="closeStudentNotificationModal()" class="btn btn-primary px-10 py-3 text-lg">OK</button>
            </div>
        </div>
    </div>

    <div id="roleAssignmentModal" class="modal-backdrop hidden">
        <div class="card p-6 w-full max-w-2xl m-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Assign Team Roles</h3>
            <div id="roleAssignCountryName" class="text-sm text-gray-600 mb-4">
                Round 1 setup: assign a role to each teammate. These can be changed later by the teacher if needed.
            </div>
            <div id="roleAssignmentList" class="space-y-3 max-h-[55vh] overflow-y-auto border rounded-lg p-3 bg-gray-50"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelRolesBtn" class="btn btn-secondary px-6" onclick="closeRoleAssignmentModal()">Cancel</button>
                <button id="saveRolesBtn" class="btn btn-success px-6" onclick="saveRoleAssignments()">Save Roles</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, runTransaction, updateDoc, writeBatch, query, where, getDocs, deleteDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let db, auth, storage;
        let user; 
        let userId, isTeacher = false, currentClassCode, myCountryName;
        
        let gameStateUnsubscribe = null;
        let playersUnsubscribe = null;
        let logUnsubscribe = null;
        let notificationUnsubscribe = null;
        let countryDataUnsubscribe = null;
        let warDeclarationsUnsubscribe = null;

        let localGameState = {};
        let localPlayersState = {};
        let localCountryData = {};
        let localWarDeclarations = {};
        let iAmRoleCaptain = false;
        let roleAssignmentShown = false;
        let confirmResolve = null;
        let isTeacherEditingRoles = false;
        const APP_ID = 'default-north-sim';

        const firebaseConfig = {
            apiKey: "AIzaSyDxnJPzzE23ikC2aag0OKzsx1oG0fExI7I",
            authDomain: "the-north-1bffa.firebaseapp.com",
            databaseURL: "https://the-north-1bffa-default-rtdb.firebaseio.com",
            projectId: "the-north-1bffa",
            storageBucket: "the-north-1bffa.appspot.com",
            messagingSenderId: "610595088129",
            appId: "1:610595088129:web:838554a99867882a219d00"
        };
        
        const BASE_INCOME = 25;
        const STARTING_BUDGETS = {
            'Tobermory': 100000, 'Grenoble': 60000, 'Omsk': 75000, 'Metz': 100000,
            'Klagenfurt': 50000, 'Tivoli': 40000, 'Razgrad': 25000
        };
        const COLONIAL_TERRITORIES = {
            'baw': { name: 'Baw', cost: 10000, income: 18, description: 'Gold mines, fish' },
            'rangoon': { name: 'Rangoon', cost: 20000, income: 15, description: 'Trade routes, forests' },
            'bauru': { name: 'Bauru', cost: 5000, income: 12, description: 'Sugar, cotton, coffee' },
            'tandil': { name: 'Tandil', cost: 10000, income: 14, description: 'Lush plains, food crops' },
            'abyssinia': { name: 'Abyssinia', cost: 15000, income: 16, description: 'Gold, metals, livestock' },
            'kamina': { name: 'Kamina', cost: 5000, income: 22, description: 'Rubber, gold, diamonds' }
        };
        const ALLIANCE_RESTRICTIONS = {
            'Tobermory': ['Metz', 'Klagenfurt', 'Tivoli'], 'Omsk': ['Metz', 'Klagenfurt', 'Tivoli'],
            'Grenoble': ['Metz', 'Klagenfurt', 'Tivoli'], 'Tivoli': ['Tobermory', 'Omsk', 'Grenoble', 'Razgrad'],
            'Metz': ['Tobermory', 'Omsk', 'Grenoble', 'Razgrad'], 'Klagenfurt': ['Tobermory', 'Omsk', 'Grenoble', 'Razgrad'],
            'Razgrad': ['Metz', 'Klagenfurt', 'Tivoli']
        };
        const STUDENT_ROLES = [
            { name: 'Secretary of the Treasury', contentId: 'treasuryCardTemplate' },
            { name: 'Secretary of War', contentId: 'militaryCardTemplate' },
            { name: 'Secretary of State', contentId: 'allianceCardTemplate' },
            { name: 'Ambassador', contentId: 'allianceCardTemplate' }, 
            { name: 'Minister of Domestic Tranquility', contentId: 'ministerCardTemplate' },
            { name: 'Historian', description: 'You are responsible for recording the events of your nation. Use the Country Log to track actions and outcomes.' },
            { name: 'Media Specialist', description: 'Your role is to craft the public image of your nation through unbiased reporting and press releases.' },
            { name: 'Director of Propaganda', description: 'Your objective is to influence other nations and bolster domestic support through compelling narratives, whether true or not.' }
        ];
        const COUNTRY_THEMES = {
            'Tobermory': {
                banner: 'https://placehold.co/1200x200/0a3d62/ffffff?text=+',
                color: 'text-white',
                emblem: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke-width="4" stroke="#e0e0e0" fill="none"><path d="M10 30 A 40 40 0 0 1 90 30" /><path d="M10 30 L10 90 A 40 40 0 0 0 50 90 A 40 40 0 0 0 90 90 L90 30" /><circle cx="50" cy="60" r="15" fill="#f9ca24"/></g></svg>`
            },
            'Metz': {
                banner: 'https://placehold.co/1200x200/4a1818/ffffff?text=+',
                color: 'text-white',
                emblem: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke-width="4" stroke="#e0e0e0" fill="none"><path d="M10 30 A 40 40 0 0 1 90 30" /><path d="M10 30 L10 90 A 40 40 0 0 0 50 90 A 40 40 0 0 0 90 90 L90 30" /><path d="M30 40 L70 80 M70 40 L30 80" stroke-width="8"/></g></svg>`
            },
            'Omsk': {
                banner: 'https://placehold.co/1200x200/222f3e/ffffff?text=+',
                color: 'text-white',
                emblem: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke-width="4" stroke="#e0e0e0" fill="none"><path d="M10 30 A 40 40 0 0 1 90 30" /><path d="M10 30 L10 90 A 40 40 0 0 0 50 90 A 40 40 0 0 0 90 90 L90 30" /><polygon points="50,40 65,70 35,70" fill="#c8d6e5"/></g></svg>`
            },
            'Grenoble': {
                banner: 'https://placehold.co/1200x200/1e3a8a/ffffff?text=+',
                color: 'text-white',
                emblem: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke-width="4" stroke="#e0e0e0" fill="none"><path d="M10 30 A 40 40 0 0 1 90 30" /><path d="M10 30 L10 90 A 40 40 0 0 0 50 90 A 40 40 0 0 0 90 90 L90 30" /><path d="M50 40 L50 80 M30 60 L70 60" stroke-width="8"/></g></svg>`
            },
            'Klagenfurt': {
                banner: 'https://placehold.co/1200x200/8c7ae6/ffffff?text=+',
                color: 'text-white',
                emblem: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke-width="4" stroke="#e0e0e0" fill="none"><path d="M10 30 A 40 40 0 0 1 90 30" /><path d="M10 30 L10 90 A 40 40 0 0 0 50 90 A 40 40 0 0 0 90 90 L90 30" /><circle cx="50" cy="60" r="10" /><circle cx="35" cy="60" r="10"/><circle cx="65" cy="60" r="10"/></g></svg>`
            },
            'Tivoli': {
                banner: 'https://placehold.co/1200x200/009432/ffffff?text=+',
                color: 'text-white',
                emblem: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke-width="4" stroke="#e0e0e0" fill="none"><path d="M10 30 A 40 40 0 0 1 90 30" /><path d="M10 30 L10 90 A 40 40 0 0 0 50 90 A 40 40 0 0 0 90 90 L90 30" /><rect x="35" y="45" width="30" height="30" fill="#f1c40f"/></g></svg>`
            },
            'Razgrad': {
                banner: 'https://placehold.co/1200x200/d35400/ffffff?text=+',
                color: 'text-white',
                emblem: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke-width="4" stroke="#e0e0e0" fill="none"><path d="M10 30 A 40 40 0 0 1 90 30" /><path d="M10 30 L10 90 A 40 40 0 0 0 50 90 A 40 40 0 0 0 90 90 L90 30" /><polygon points="50,40 70,75 30,75" stroke-width="8"/></g></svg>`
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp(firebaseConfig);
            auth = getAuth();
            db = getFirestore();
            storage = getStorage();
            
            document.getElementById('signInBtn').onclick = signInWithGoogle;
            document.getElementById('joinClassBtn').onclick = joinSimulation;
            document.getElementById('confirmCancelBtn').onclick = () => closeConfirmModal(false);
            document.getElementById('confirmOkBtn').onclick = () => closeConfirmModal(true);

            // Disable purchase buttons and domestic sliders until player data is ready
            ['armyQuantity-main','navyQuantity-main','armyQuantity-war','navyQuantity-war'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.setAttribute('disabled', 'disabled');
            });
            ['healthcareSlider','educationSlider','infrastructureSlider','militaryBudgetSlider'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.setAttribute('disabled', 'disabled');
            });

            const flagUploader = document.getElementById('flagUploader');
            if(flagUploader) {
                flagUploader.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('flagPreview').src = event.target.result;
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            onAuthStateChanged(auth, async (currentUser) => {
                user = currentUser;
                if (user) {
                    userId = user.uid;
                    const displayName = user.displayName || user.email || 'User';
                    updateConnectionStatus(true, `Signed in as ${displayName}`);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('classCodeScreen').classList.remove('hidden');
                } else {
                    updateConnectionStatus(false, 'Disconnected');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('classCodeScreen').classList.add('hidden');
                    document.getElementById('gameContainer').classList.add('hidden');
                    cleanupListeners();
                }
            });
        });

        function updateConnectionStatus(connected, message) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
                if (connected) {
                    statusEl.classList.add('bg-green-500');
                } else {
                    statusEl.classList.add('bg-red-500');
                }
            }
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
            }
        }

        function showInfoModal(title, bodyHtml) {
            document.getElementById('infoModalTitle').textContent = title;
            document.getElementById('infoModalBody').innerHTML = bodyHtml;
            document.getElementById('infoModal').classList.remove('hidden');
        }

        window.closeInfoModal = function() {
            document.getElementById('infoModal').classList.add('hidden');
        }

        function showConfirmModal(title, body) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').innerHTML = body;
            document.getElementById('confirmModal').classList.remove('hidden');
            return new Promise(resolve => {
                confirmResolve = resolve;
            });
        }

        function closeConfirmModal(result) {
            document.getElementById('confirmModal').classList.add('hidden');
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        }
        
        function showStudentNotificationModal(notificationData, notificationId) {
            const modal = document.getElementById('studentNotificationModal');
            const titleEl = document.getElementById('studentNotificationTitle');
            const bodyEl = document.getElementById('studentNotificationBody');
            if (notificationData.type === 'war_declared') {
                titleEl.textContent = '⚔️ WAR DECLARED!';
                bodyEl.innerHTML = `<p class="font-semibold">${notificationData.message}</p>`;
            } else if (notificationData.type === 'alliance_request') {
                titleEl.textContent = 'Alliance Request';
                bodyEl.innerHTML = `
                    <p class="font-semibold mb-4">${notificationData.fromCountry || notificationData.from} has proposed an alliance.</p>
                    <div class="flex gap-3 justify-center">
                        <button class="btn btn-success px-6" onclick="acceptAllianceRequest('${notificationId}','${notificationData.fromPlayerId}')">Accept</button>
                        <button class="btn btn-danger px-6" onclick="rejectAllianceRequest('${notificationId}','${notificationData.fromPlayerId}')">Reject</button>
                    </div>
                `;
            } else {
                titleEl.textContent = 'Update from Teacher';
                bodyEl.innerHTML = `<p class="font-semibold">${notificationData.message}</p>`;
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.card').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.card').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeStudentNotificationModal = async function() {
            const modal = document.getElementById('studentNotificationModal');
            modal.classList.add('hidden');
            
            // Delete the notification after viewing
            const notificationColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${userId}/notifications`);
            const q = query(notificationColRef);
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        };

        window.acknowledgeWarDeclaration = async function() {
            // Same as closeStudentNotificationModal
            await closeStudentNotificationModal();
        };


        // Load existing roster from database
        window.loadExistingRoster = async function() {
            const rosterListEl = document.getElementById('rosterList');
            const periodBreakdownEl = document.getElementById('periodBreakdown');
            const classPeriodSelectEl = document.getElementById('classPeriodSelect');
            
            try {
                const rosterColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/roster`);
                const snapshot = await getDocs(rosterColRef);
                
                if (snapshot.empty) {
                    rosterListEl.innerHTML = '<p class="text-gray-500 text-center">No students added yet</p>';
                    periodBreakdownEl.innerHTML = '<p class="text-gray-500">No students to display</p>';
                    return;
                }
                
                const students = [];
                snapshot.forEach(doc => {
                    students.push({ email: doc.id, ...doc.data() });
                });
                
                // Sort by email
                students.sort((a, b) => a.email.localeCompare(b.email));
                
                // Display roster list with checkboxes
                rosterListEl.innerHTML = students.map(student => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <label class="flex items-center flex-grow cursor-pointer">
                            <input type="checkbox" value="${student.email}" 
                                   class="h-4 w-4 rounded border-gray-300 text-indigo-600 mr-3">
                            <div class="flex-grow">
                                <span class="font-medium text-gray-800">${student.email}</span>
                                <span class="text-sm text-gray-600 ml-3">${student.country}</span>
                                ${student.period ? `<span class="text-xs text-gray-500 ml-2">(Period ${student.period})</span>` : ''}
                            </div>
                        </label>
                    </div>
                `).join('');
                
                // Create period breakdown
                const periodGroups = {};
                students.forEach(student => {
                    const period = student.period || 'Unassigned';
                    if (!periodGroups[period]) {
                        periodGroups[period] = [];
                    }
                    periodGroups[period].push(student);
                });
                
                // Sort periods
                const sortedPeriods = Object.keys(periodGroups).sort((a, b) => {
                    if (a === 'Unassigned') return 1;
                    if (b === 'Unassigned') return -1;
                    return parseInt(a) - parseInt(b);
                });
                
                periodBreakdownEl.innerHTML = sortedPeriods.map(period => {
                    const studentsInPeriod = periodGroups[period];
                    return `
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2">
                                ${period === 'Unassigned' ? 'Unassigned' : `Period ${period}`} 
                                (${studentsInPeriod.length} student${studentsInPeriod.length !== 1 ? 's' : ''})
                            </h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                ${studentsInPeriod.map(s => `<div>${s.email} - ${s.country}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Populate class period selector
                const assignedPeriods = sortedPeriods.filter(p => p !== 'Unassigned');
                classPeriodSelectEl.innerHTML = '<option value="">-- Select Period --</option>' +
                    assignedPeriods.map(p => `<option value="${p}">Period ${p}</option>`).join('');
                
            } catch (error) {
                console.error("Failed to load roster:", error);
                rosterListEl.innerHTML = `<p class="text-red-500">Error loading roster: ${error.message}</p>`;
            }
        };
        
        async function notifyApprovers(warId, warDeclaration) {
             const approverRoles = ['Secretary of State', 'Minister of Domestic Tranquility'];
             const countryPlayers = Object.values(localPlayersState).filter(p => p.country === myCountryName);
             
             for(const player of countryPlayers) {
                if(approverRoles.includes(player.role)) {
                    const player_id = Object.keys(localPlayersState).find(key => localPlayersState[key] === player);
                    const notifCol = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${player_id}/notifications`);
                    await addDoc(notifCol, {
                        type: 'war_approval_request',
                        from: myCountryName,
                        message: `Your approval is required for a declaration of war.`,
                        warId: warId,
                        timestamp: serverTimestamp()
                    });
                }
             }
        }
        
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                document.getElementById('loginError').textContent = `Sign-in failed: ${error.message}`;
            }
        }

        async function joinSimulation() {
            if (!user || !user.email) {
                showError('classCodeError', 'Authentication error. Please sign in again.');
                return;
            }

            const classCode = document.getElementById('classCodeInput').value.trim().toUpperCase();
            if (!classCode) {
                showError('classCodeError', 'Please enter a class code.');
                return;
            }
            currentClassCode = classCode;
            const joinBtn = document.getElementById('joinClassBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = 'Verifying...';

            try {
                const teacherRef = doc(db, `apps/${APP_ID}/teachers`, user.email);
                const simRef = doc(db, `apps/${APP_ID}/simulations`, classCode);
                const rosterRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/roster`, user.email);
                
                const [teacherSnap, simSnap, rosterSnap] = await Promise.all([getDoc(teacherRef), getDoc(simRef), getDoc(rosterRef)]);

                if (teacherSnap.exists()) {
                    await setupNewTeacher(simSnap, simRef);
                } else if (rosterSnap.exists()) {
                    await setupNewStudent(simSnap, rosterSnap);
                    document.getElementById('classCodeScreen').classList.add('hidden');
                    document.getElementById('gameContainer').classList.remove('hidden');
                    setupFirestoreListeners();
                } else {
                    showError('classCodeError', 'You are not on the roster for this class.');
                }
            } catch (error) {
                console.error("Error joining simulation:", error);
                showError('classCodeError', `An error occurred: ${error.message}`);
            } finally {
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join / Create Simulation';
            }
        }

        async function setupNewTeacher(simSnap, simRef) {
            isTeacher = true;
            myCountryName = 'Teacher';
            if (!simSnap.exists()) {
                await setDoc(simRef, {
                    teacherId: user.uid,
                    teacherEmail: user.email,
                    round: 1,
                    phase: 'waiting',
                    timerEnds: null,
                });
            }
            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, userId);
            await setDoc(playerRef, { name: user.displayName, isTeacher: true }, { merge: true });

            document.getElementById('classCodeScreen').classList.add('hidden');
            document.getElementById('rosterScreen').classList.remove('hidden');
            document.getElementById('rosterClassCode').textContent = currentClassCode;
            loadExistingRoster();
        }

        async function setupNewStudent(simSnap, rosterSnap) {
            isTeacher = false;
            if (!simSnap.exists()) {
                showError('classCodeError', 'This class code does not exist.');
                throw new Error('Simulation not found');
            }
            myCountryName = rosterSnap.data().country;

            const countryRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/countryData`, myCountryName);
            const countrySnap = await getDoc(countryRef);
            const initialPnp = countrySnap.exists() ? countrySnap.data().pnp : 100;
            const roleAssignments = countrySnap.exists() ? (countrySnap.data().roleAssignments || {}) : {};
            const preAssignedRole = roleAssignments[user.email] || null;

            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, userId);
            const playerSnap = await getDoc(playerRef);

            if (!playerSnap.exists()) {
                const initialPlayerData = {
                    name: user.displayName, email: user.email, country: myCountryName,
                    isTeacher: false, dollars: STARTING_BUDGETS[myCountryName] || 50000,
                    pnp: initialPnp, income: BASE_INCOME, army: 0, navy: 0,
                    colonies: {}, colonialPlans: {}, alliances: {},
                    militaryBudgetPercentage: 25, 
                    domesticSpending: { healthcare: 20, education: 20, infrastructure: 20 },
                    happinessIndex: 100,
                    activeEvents: [],
                    militarySpendingThisRound: 0,
                    role: preAssignedRole,
                };
                await setDoc(playerRef, initialPlayerData);
            }
            setupStudentTabs();
        }
        
        function cleanupListeners() {
            if (gameStateUnsubscribe) gameStateUnsubscribe();
            if (playersUnsubscribe) playersUnsubscribe();
            if (logUnsubscribe) logUnsubscribe();
            if (notificationUnsubscribe) notificationUnsubscribe();
            if (countryDataUnsubscribe) countryDataUnsubscribe();
            if (warDeclarationsUnsubscribe) warDeclarationsUnsubscribe();
        }

        function setupFirestoreListeners() {
            cleanupListeners();
            
            const gameDocRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}`);
            gameStateUnsubscribe = onSnapshot(gameDocRef, (doc) => {
                if (doc.exists()) {
                    localGameState = doc.data();
                    updateGameUI();
                    maybeTriggerRoleAssignment();
                }
            });

            const playersColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`);
            let playersFirstLoad = true;
            playersUnsubscribe = onSnapshot(playersColRef, (snapshot) => {
                localPlayersState = {};
                snapshot.forEach(doc => { localPlayersState[doc.id] = doc.data(); });
                updateAllPlayersUI();
                maybeTriggerRoleAssignment();
                // after initial players load, ensure domestic UI is synced immediately
                if (playersFirstLoad) {
                    playersFirstLoad = false;
                    // call immediate domestic updater so sliders/values show right away
                    if (typeof updateDomesticSpendingImmediate === 'function') {
                        updateDomesticSpendingImmediate();
                    }
                }
            });

            const countryDataColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/countryData`);
            countryDataUnsubscribe = onSnapshot(countryDataColRef, (snapshot) => {
                localCountryData = {};
                snapshot.forEach(doc => { localCountryData[doc.id] = doc.data(); });
                updateAllPlayersUI(); 
                maybeTriggerRoleAssignment();
            });
            
            const warDeclarationsColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/warDeclarations`);
            warDeclarationsUnsubscribe = onSnapshot(warDeclarationsColRef, (snapshot) => {
                localWarDeclarations = {};
                snapshot.forEach(doc => { localWarDeclarations[doc.id] = doc.data(); });
                updateAllPlayersUI();
            });


            if (!isTeacher) {
                const logColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${userId}/log`);
                logUnsubscribe = onSnapshot(query(logColRef), (snapshot) => {
                    const logEntries = snapshot.docs.map(d => d.data());
                    updateEventLog(logEntries);
                });
                
                const notificationColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${userId}/notifications`);
                notificationUnsubscribe = onSnapshot(query(notificationColRef), (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            showStudentNotificationModal(change.doc.data(), change.doc.id);
                        }
                    });
                });
            }
        }
        
        function getMyRoles() { // Plural
            const myPlayerData = localPlayersState[userId];
            if (myPlayerData && myPlayerData.roles && Array.isArray(myPlayerData.roles)) {
                return myPlayerData.roles;
            }
            // Fallback for old structure
            if (myPlayerData && myPlayerData.role) {
                return [myPlayerData.role];
            }
            return [];
        }

        async function updateWarDeclarationUI() {
            const myRoles = getMyRoles();
            const warInterface = document.getElementById('warDeclarationInterface');
            const round = localGameState.round || 1;

            if (warInterface) {
                if (myRoles.includes('Secretary of War') && round >= 4) {
                    warInterface.classList.remove('hidden');
                } else {
                    warInterface.classList.add('hidden');
                }
            }

            if (myRoles.includes('Secretary of State') || myRoles.includes('Minister of Domestic Tranquility')) {
                if (typeof loadWarApprovals === 'function') {
                    try { await loadWarApprovals(); } catch (err) { console.error('loadWarApprovals failed:', err); }
                }
            }

            if (myRoles.includes('Secretary of War')) {
                if (typeof loadPendingWarDeclarations === 'function') {
                    try { await loadPendingWarDeclarations(); } catch (err) { console.error('loadPendingWarDeclarations failed:', err); }
                }
            }
        }

        window.switchTab = function(targetId) {
            document.querySelectorAll('#roleTabs .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === targetId);
            });
            document.querySelectorAll('#roleTabContent .tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === targetId);
            });
            updateWarDeclarationUI();
        }

        async function createLog(message, forUserId = userId) {
            if (isTeacher && !forUserId) return; // Teachers don't have personal logs
            const finalUserId = isTeacher ? forUserId : userId;
            const logColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${finalUserId}/log`);
            await addDoc(logColRef, { message, timestamp: serverTimestamp() });
        }
        
        function updateGameUI() {
            const { round, phase, timerEnds } = localGameState;
            document.getElementById('currentRound').textContent = round || 1;
            const phaseIndicator = document.getElementById('phaseIndicator');
            const phaseTextEl = document.getElementById('phaseText');
            let phaseDisplay, phaseColor;
            switch (phase) {
                case 'active': phaseDisplay = `Active - ${getTimerDisplay(timerEnds)}`; phaseColor = 'bg-green-600'; break;
                case 'review': phaseDisplay = 'Review Phase'; phaseColor = 'bg-yellow-500'; break;
                default: phaseDisplay = 'Waiting for Teacher'; phaseColor = 'bg-gray-500';
            }
            phaseTextEl.textContent = phaseDisplay;
            phaseIndicator.className = `text-center text-white rounded-full px-6 py-2 ${phaseColor}`;

            if (isTeacher) {
                document.getElementById('teacherPanel').classList.remove('hidden');
                document.getElementById('studentRoleInterface').classList.add('hidden');
                document.getElementById('startRoundBtn').disabled = phase === 'active';
                document.getElementById('endRoundBtn').disabled = phase !== 'active';
                document.getElementById('colonialChanceBtn').disabled = phase !== 'review';
                document.getElementById('checkAlliancesBtn').disabled = phase !== 'review';
                document.getElementById('nextRoundBtn').disabled = phase !== 'review';
            }
            // Keep student UI (e.g., war button visibility) in sync when only the game doc changes
            if (!isTeacher) {
                updateWarDeclarationUI();
            }
        }
        
        let countdownInterval;
        function getTimerDisplay(timerEnds) {
            clearInterval(countdownInterval);

            const toMillis = (t) => {
                if (!t) return null;
                if (typeof t.toDate === 'function') return t.toDate().getTime(); // Firestore Timestamp
                if (t instanceof Date) return t.getTime();                        // JS Date
                const parsed = new Date(t);
                return isNaN(parsed.getTime()) ? null : parsed.getTime();         // string/number
            };

            // Prefer server-derived timerStartedAt + duration from game doc to avoid client clock skew
            const endTime = (() => {
                try {
                    if (localGameState?.timerStartedAt && localGameState?.timerDurationMinutes) {
                        const startMs = (typeof localGameState.timerStartedAt.toDate === 'function')
                            ? localGameState.timerStartedAt.toDate().getTime()
                            : new Date(localGameState.timerStartedAt).getTime();
                        return startMs + (Number(localGameState.timerDurationMinutes) * 60000);
                    }
                } catch (e) {
                    // ignore and fallback
                }
                // fallback to the original timerEnds value (backwards compatibility)
                if (!timerEnds) return null;
                return toMillis(timerEnds);
            })();

            if (!endTime || Number.isNaN(endTime)) return '00:00';

            const update = () => {
                const now = Date.now();
                const timeLeft = Math.max(0, endTime - now);
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (localGameState.phase === 'active') {
                    const phaseTextEl = document.getElementById('phaseText');
                    if (phaseTextEl) phaseTextEl.textContent = `Active - ${display}`;
                }
                if (timeLeft <= 0) clearInterval(countdownInterval);
            };

            update();
            countdownInterval = setInterval(update, 1000);
            return '';
        }

        function updateAllPlayersUI() {
            const myData = localPlayersState[userId];
            // Add this inside updateAllPlayersUI() for students
            if (!isTeacher && myCountryName) {
                const banner = document.getElementById('studentCountryBanner');
                const theme = COUNTRY_THEMES[myCountryName];
                if (banner && theme) {
                    banner.style.backgroundImage = `url('${theme.banner}')`;
                    banner.classList.remove('hidden');
                    document.getElementById('bannerCountryName').textContent = myCountryName;
                    document.getElementById('bannerEmblem').innerHTML = theme.emblem;
                }
                
                document.getElementById('displayPlayerName').textContent = user.displayName || user.email;
                document.getElementById('displayClassCode').textContent = currentClassCode;
                // Enable student controls as soon as player data is present
                if (myData) enableStudentControls();
            }
            if (myData && !isTeacher) {
                document.getElementById('countryBudget').textContent = (myData.dollars || 0).toLocaleString();
                document.getElementById('roundIncome').textContent = (myData.income || 0).toLocaleString();
                document.getElementById('armyUnits').textContent = myData.army || 0;
                document.getElementById('navyUnits').textContent = myData.navy || 0;
                document.getElementById('happinessTopDisplay').textContent = myData.happinessIndex || 100;

                // Initialize sliders from database
                const domesticSpending = myData.domesticSpending || { healthcare: 20, education: 20, infrastructure: 20 };
                document.getElementById('healthcareSlider').value = domesticSpending.healthcare;
                document.getElementById('educationSlider').value = domesticSpending.education;
                document.getElementById('infrastructureSlider').value = domesticSpending.infrastructure;

                // Display active events
                const activeEvents = myData.activeEvents || [];
                const eventsListEl = document.getElementById('activeEventsList');
                if (eventsListEl) {
                    if (activeEvents.length > 0) {
                        eventsListEl.innerHTML = activeEvents.map(evt =>
                            `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800">${evt}</div>`
                        ).join('');
                    } else {
                        eventsListEl.innerHTML = '<p class="text-gray-500">No active events.</p>';
                    }
                }
                
                // Update military budget displays
                const militaryBudget = Math.floor((myData.dollars || 0) * ((myData.militaryBudgetPercentage || 25) / 100));
                const remainingBudget = militaryBudget - (myData.militarySpendingThisRound || 0);

                ['main', 'war'].forEach(context => {
                    const totalEl = document.getElementById(`warTotalBudget-${context}`);
                    const remainingEl = document.getElementById(`warRemainingBudget-${context}`);
                    if (totalEl) totalEl.textContent = `$${militaryBudget.toLocaleString()}`;
                    if (remainingEl) remainingEl.textContent = `$${remainingBudget.toLocaleString()}`;
                });
                
                const treasuryTotal = document.getElementById('treasuryTotalBudget');
                const treasuryMilitary = document.getElementById('treasuryMilitaryBudget');
                if (treasuryTotal) treasuryTotal.textContent = `$${(myData.dollars || 0).toLocaleString()}`;
                if (treasuryMilitary) treasuryMilitary.textContent = `$${militaryBudget.toLocaleString()}`;

                // Update slider
                const slider = document.getElementById('militaryBudgetSlider');
                if (slider) slider.value = myData.militaryBudgetPercentage || 25;

                // Update UI based on slider values
                updateDomesticSpending();
            }
            updateWarDeclarationUI();
            updateLeaderboard();
            const colonialPlanningUI = document.getElementById('colonialPlanning');
            if(colonialPlanningUI) populateColonialOptions();
        }
        
        function updateEventLog(entries) {
            const logEl = document.getElementById('eventLog');
            if (!entries || entries.length === 0) {
                logEl.innerHTML = `<p class="text-gray-500">No events yet.</p>`;
                return;
            }
            logEl.innerHTML = entries
                .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
                .map(entry => `<div class="p-2 rounded bg-gray-50">${entry.message}</div>`)
                .join('');
        }

        function calculateTotalPnp(player) {
            const armyPnp = (player.army || 0) * 750;
            const navyPnp = (player.navy || 0) * 1000;
            const coloniesPnp = Object.values(player.colonies || {}).reduce((sum, colony) => sum + (colony.cost || 0), 0);
            return (player.pnp || 0) + armyPnp + navyPnp + coloniesPnp;
        }

        function updateLeaderboard() {
            const playersArray = Object.values(localPlayersState).filter(p => !p.isTeacher);
            playersArray.forEach(p => {
                p.basePnp = (localCountryData[p.country]?.pnp || 100) + (p.pnp - 100);
                const armyPnp = (p.army || 0) * 750;
                const navyPnp = (p.navy || 0) * 1000;
                const coloniesPnp = Object.values(p.colonies || {}).reduce((sum, colony) => sum + (colony.cost || 0), 0);
                p.assetScore = armyPnp + navyPnp + coloniesPnp;
                p.totalScore = p.basePnp + p.assetScore;
            });
            playersArray.sort((a, b) => b.totalScore - a.totalScore);
            const listEl = document.getElementById('leaderboardList');
            listEl.innerHTML = playersArray.map((p, index) => {
                const isMe = p.country === myCountryName;
                const bgColor = isMe ? 'bg-indigo-100' : 'bg-gray-50';
                const countryData = localCountryData[p.country] || {};
                const flagUrl = countryData.flagUrl;
                const emblem = COUNTRY_THEMES[p.country]?.emblem || `<div class="w-8 h-6 bg-gray-300 rounded-sm"></div>`;
                const flagElement = flagUrl 
                    ? `<img src="${flagUrl}" alt="${p.country} flag" class="w-8 h-6 object-cover rounded-sm shadow-sm">` 
                    : `<div class="w-8 h-6 flex items-center justify-center">${emblem}</div>`;

                return `
                    <div class="p-3 rounded-lg ${bgColor} flex justify-between items-center">
                        <div class="flex items-center flex-grow">
                            ${flagElement}
                            <div class="ml-3">
                                <span class="font-bold text-gray-800">${index+1}. ${p.country}</span>
                                <span class="text-sm text-gray-500 ml-2">(${p.name})</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <span class="font-bold text-indigo-700">${p.totalScore.toLocaleString()} PNP</span>
                             <div class="text-xs text-gray-500">Base: ${p.basePnp.toLocaleString()} + Assets: ${p.assetScore.toLocaleString()}</div>
                        </div>
                    </div>`;
            }).join('');
        }
        
        function populateColonialOptions() {
            const container = document.getElementById('colonialPlanning');
            if (!container) return;
            container.innerHTML = '';
            const myData = localPlayersState[userId] || {};
            const phase = localGameState.phase;

            for (const [key, territory] of Object.entries(COLONIAL_TERRITORIES)) {
                const isOwnedByAnyone = Object.values(localPlayersState).some(p => p.colonies && p.colonies[key]);
                const haveIPlanned = myData.colonialPlans && myData.colonialPlans[key];
                let buttonHtml;
                if(isOwnedByAnyone) {
                    const owner = Object.values(localPlayersState).find(p => p.colonies && p.colonies[key]);
                    buttonHtml = `<button class="btn btn-secondary w-full" disabled>Owned by ${owner.country}</button>`;
                } else if (haveIPlanned) {
                    buttonHtml = `<button class="btn btn-success w-full" disabled>Attempt Planned</button>`;
                } else {
                    buttonHtml = `<button class="btn btn-warning w-full" onclick="planColonization('${key}')" ${phase !== 'active' ? 'disabled' : ''}>Plan Attempt</button>`;
                }
                container.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg space-y-2">
                        <div class="font-bold">${territory.name}</div>
                        <div class="text-sm text-gray-600">Cost: ${territory.cost.toLocaleString()} $ | Income: ${territory.income} $</div>
                        ${buttonHtml}
                    </div>`;
            }
        }

        function updateMyAllianceUI(myAlliances) {
            const container = document.getElementById('myAlliances');
            if (!container) return;
            const allies = Object.keys(myAlliances).filter(id => myAlliances[id] === true);
            if(allies.length === 0) {
                container.innerHTML = `<h4 class="font-semibold mt-4">My Current Allies:</h4> <p class="text-gray-500">None</p>`;
            } else {
                const allyNames = allies.map(id => localPlayersState[id]?.country || '...').join(', ');
                container.innerHTML = `<h4 class="font-semibold mt-4">My Current Allies:</h4> <p class="text-green-700 font-semibold">${allyNames}</p>`;
            }
        }
        
        window.uploadFlag = async function() {
            const uploader = document.getElementById('flagUploader');
            const uploadBtn = document.getElementById('uploadFlagBtn');
            const file = uploader.files[0];

            if (!file) return showInfoModal("No File", "<p>Please select a file to upload.</p>");
            if (file.size > 1024 * 1024) return showInfoModal("File Too Large", "<p>Please select an image smaller than 1MB.</p>");

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64String = event.target.result;
                    const storageRef = ref(storage, `apps/${APP_ID}/simulations/${currentClassCode}/flags/${myCountryName}.png`);
                    const uploadResult = await uploadString(storageRef, base64String, 'data_url');
                    const downloadURL = await getDownloadURL(uploadResult.ref);

                    const countryDocRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/countryData`, myCountryName);
                    await setDoc(countryDocRef, { flagUrl: downloadURL }, { merge: true });

                    showInfoModal("Success!", "<p>Your national flag has been updated.</p>");
                    await createLog(`Uploaded a new national flag.`);
                };
                reader.readAsDataURL(file);
            } catch(error) {
                console.error("Flag upload failed:", error);
                showInfoModal("Upload Failed", `<p>An error occurred: ${error.message}</p>`);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Flag';
            }
        }

        // ==== Domestic Policy System ====
        // Simple debounce helper
        function debounce(fn, wait) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        // Immediate updater used once after initial players load
        window.updateDomesticSpendingImmediate = function() {
            const myData = localPlayersState[userId];
            if (!myData) return;

            // enable sliders now that data is present
            ['healthcareSlider','educationSlider','infrastructureSlider','militaryBudgetSlider'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.removeAttribute('disabled');
            });
            // enable purchase buttons that call purchaseUnits
            document.querySelectorAll('button[onclick]').forEach(btn => {
                try {
                    const onclick = btn.getAttribute('onclick') || '';
                    if (onclick.includes('purchaseUnits')) {
                        btn.removeAttribute('disabled');
                    }
                } catch(e) {}
            });

            const totalBudget = myData.dollars || 0;
            const healthcare = parseInt(document.getElementById('healthcareSlider')?.value || 20);
            const education = parseInt(document.getElementById('educationSlider')?.value || 20);
            const infrastructure = parseInt(document.getElementById('infrastructureSlider')?.value || 20);

            document.getElementById('healthcarePercent').textContent = `${healthcare}%`;
            document.getElementById('educationPercent').textContent = `${education}%`;
            document.getElementById('infrastructurePercent').textContent = `${infrastructure}%`;

            const healthcareDollars = Math.floor(totalBudget * healthcare / 100);
            const educationDollars = Math.floor(totalBudget * education / 100);
            const infrastructureDollars = Math.floor(totalBudget * infrastructure / 100);

            document.getElementById('healthcareDollars').textContent = `($${healthcareDollars.toLocaleString()})`;
            document.getElementById('educationDollars').textContent = `($${educationDollars.toLocaleString()})`;
            document.getElementById('infrastructureDollars').textContent = `($${infrastructureDollars.toLocaleString()})`;

            const warnings = [];
            const total = healthcare + education + infrastructure;
            if (total < 15) warnings.push({ type: 'danger', msg: '💀 CATASTROPHIC: Revolution imminent!' });
            else if (total < 30) warnings.push({ type: 'danger', msg: '🚨 CRISIS: Total domestic spending critically low!' });
            else if (total < 45) warnings.push({ type: 'warning', msg: '⚠️ WARNING: Unrest growing' });

            if (healthcare < 5) warnings.push({ type: 'danger', msg: '🏥 Healthcare system collapsed' });
            else if (healthcare < 10) warnings.push({ type: 'danger', msg: '🏥 Healthcare crisis imminent' });
            else if (healthcare < 15) warnings.push({ type: 'warning', msg: '🏥 Healthcare strained' });

            if (education < 5) warnings.push({ type: 'danger', msg: '📚 Education system destroyed' });
            else if (education < 10) warnings.push({ type: 'danger', msg: '📚 Education collapsing' });
            else if (education < 15) warnings.push({ type: 'warning', msg: '📚 Education declining' });

            if (infrastructure < 5) warnings.push({ type: 'danger', msg: '🛤️ Infrastructure failed' });
            else if (infrastructure < 10) warnings.push({ type: 'danger', msg: '🛤️ Infrastructure failing' });
            else if (infrastructure < 15) warnings.push({ type: 'warning', msg: '🛤️ Infrastructure deteriorating' });

            const warningsDiv = document.getElementById('domesticWarnings');
            if(warningsDiv) {
                if (warnings.length === 0) {
                    warningsDiv.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800">✓ Domestic spending adequate</div>';
                } else {
                    warningsDiv.innerHTML = warnings.map(w => 
                        `<div class="bg-${w.type === 'danger' ? 'red' : 'yellow'}-50 border border-${w.type === 'danger' ? 'red' : 'yellow'}-300 rounded-lg p-3 text-${w.type === 'danger' ? 'red' : 'yellow'}-800 font-semibold">${w.msg}</div>`
                    ).join('');
                }
            }

            const happiness = myData.happinessIndex || 100;
            document.getElementById('happinessDisplay').textContent = happiness;
            document.getElementById('happinessBar').style.width = `${Math.min(100, happiness)}%`;
        };

        // Enable controls for student interactions (called when student data is ready)
        function enableStudentControls() {
            ['armyQuantity-main','navyQuantity-main','armyQuantity-war','navyQuantity-war',
             'healthcareSlider','educationSlider','infrastructureSlider','militaryBudgetSlider'
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.removeAttribute('disabled');
            });
            // Also enable purchase buttons that call purchaseUnits
            document.querySelectorAll('button[onclick]').forEach(btn => {
                try {
                    const onclick = btn.getAttribute('onclick') || '';
                    if (onclick.includes('purchaseUnits')) {
                        btn.removeAttribute('disabled');
                    }
                } catch(e) {}
            });
        }

        // Debounced version for UI event handlers
        window.updateDomesticSpending = debounce(function() {
            updateDomesticSpendingImmediate();
        }, 150);

        window.saveDomesticBudget = async function() {
            const healthcare = parseInt(document.getElementById('healthcareSlider').value);
            const education = parseInt(document.getElementById('educationSlider').value);
            const infrastructure = parseInt(document.getElementById('infrastructureSlider').value);
            
            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, userId);
            try {
                await updateDoc(playerRef, {
                    "domesticSpending.healthcare": healthcare,
                    "domesticSpending.education": education,
                    "domesticSpending.infrastructure": infrastructure
                });
                showInfoModal("Success", "<p>Domestic budget allocations saved.</p>");
                createLog(`Updated domestic budget: Healthcare ${healthcare}%, Education ${education}%, Infrastructure ${infrastructure}%.`);
            } catch (error) {
                console.error("Failed to save domestic budget:", error);
                showInfoModal("Error", `<p>Could not save budget: ${error.message}</p>`);
            }
        };

        // ==== Teacher Controls ====
        window.endRound = async function() {
            showInfoModal("Processing...", "<p>Ending round and calculating effects. This may take a moment.</p>");
            
            const batch = writeBatch(db);
            const playersColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`);
            const q = query(playersColRef, where("isTeacher", "==", false));
            const playerDocs = await getDocs(q);

            for (const playerDoc of playerDocs.docs) {
                const pId = playerDoc.id;
                const player = playerDoc.data();
                const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, pId);
                
                const spending = player.domesticSpending || { healthcare: 20, education: 20, infrastructure: 20 };
                const total = spending.healthcare + spending.education + spending.infrastructure;
            
                let happinessChange = 0;
                let incomeModifier = 1.0;
                let unitLosses = { army: 0, navy: 0 };
                let events = [];
                
                if (total >= 75) { happinessChange = 10; incomeModifier = 1.15; events.push("✓ HIGH PROSPERITY: Economy booming! (+15% income)"); } 
                else if (total >= 60) { happinessChange = 5; incomeModifier = 1.05; events.push("✓ Stable conditions (+5% income)"); } 
                else if (total >= 45) { happinessChange = 0; events.push("~ Barely adequate (no changes)"); } 
                else if (total >= 30) { happinessChange = -5; incomeModifier = 0.85; if (Math.random() < 0.2) unitLosses.army = 1; events.push("⚠️ DISCONTENT: Unrest growing (-15% income)"); } 
                else if (total >= 15) { happinessChange = -10; incomeModifier = 0.65; unitLosses.army = Math.floor(Math.random() * 2) + 1; events.push("🚨 CRISIS: Mass protests (-35% income, lost " + unitLosses.army + " army)"); } 
                else { happinessChange = -20; incomeModifier = 0.4; unitLosses.army = 2; events.push("💀 CATASTROPHIC: Revolution imminent! (-60% income, lost 2 army)"); }
                
                if (spending.healthcare < 5) { events.push("🏥 PLAGUE: Healthcare collapsed"); unitLosses.army += 2; incomeModifier *= 0.7; } 
                else if (spending.healthcare < 10) { events.push("🏥 Disease outbreak: Lost units"); unitLosses.army += 1; }
                
                if (spending.education < 5) { events.push("📚 ILLITERACY: Generation lost"); incomeModifier *= 0.5; } 
                else if (spending.education < 10) { events.push("📚 Factory accidents (-20% income)"); incomeModifier *= 0.8; }
                
                if (spending.infrastructure < 5) { events.push("🛤️ COLLAPSE: Cannot trade"); incomeModifier *= 0.5; } 
                else if (spending.infrastructure < 10) { events.push("🛤️ Trade routes severed (-25% income)"); incomeModifier *= 0.75; }

                const newHappiness = Math.max(0, Math.min(200, (player.happinessIndex || 100) + happinessChange));
                const newIncome = Math.max(5, Math.floor((player.income || BASE_INCOME) * incomeModifier));
                const newArmy = Math.max(0, (player.army || 0) - unitLosses.army);
                const newDollars = (player.dollars || 0) + newIncome;

                batch.update(playerRef, {
                    happinessIndex: newHappiness,
                    income: newIncome,
                    army: newArmy,
                    dollars: newDollars,
                    activeEvents: events
                });

                for (const event of events) {
                    const logColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${pId}/log`);
                    const logDocRef = doc(logColRef);
                    batch.set(logDocRef, { message: event, timestamp: serverTimestamp() });
                }
            }

            const gameDocRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}`);
            batch.update(gameDocRef, { phase: 'review' });
            
            await batch.commit();
            closeInfoModal();
        };


        // ==== War Declaration System ====
        async function loadPendingWarDeclarations() {
            const pendingDiv = document.getElementById('pendingWarDeclarations');
            const listDiv = document.getElementById('pendingWarList');
            if (!pendingDiv || !listDiv) return;
            
            const warsQuery = query(
                collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/pendingWars`),
                where('declaringCountry', '==', myCountryName)
            );
            
            const snapshot = await getDocs(warsQuery);
            if (snapshot.empty) {
                pendingDiv.classList.add('hidden');
                return;
            }
            
            pendingDiv.classList.remove('hidden');
            listDiv.innerHTML = snapshot.docs.map(doc => {
                const data = doc.data();
                const targets = data.targetCountries.map(t => t.country).join(', ');
                return `<div class="bg-yellow-50 p-3 rounded">
                    Awaiting approval to declare war on: <strong>${targets}</strong>
                </div>`;
            }).join('');
        }

        async function loadWarApprovals() {
            const myRoles = getMyRoles();
            const container = document.querySelector('.tab-panel.active');
            if (!container || (!myRoles.includes('Secretary of State') && !myRoles.includes('Minister of Domestic Tranquility'))) return;

            const approvalKey = myRoles.includes('Secretary of State') ? 'secretaryOfState' : 'ministerOfDomestic';
            
            const warsQuery = query(collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/pendingWars`));
            
            const snapshot = await getDocs(warsQuery);
            const needsApproval = snapshot.docs.filter(doc => 
                doc.data().declaringCountry === myCountryName && doc.data().approvals[approvalKey] === false
            );
            
            const listDiv = container.querySelector('.war-approval-list');
            const noApprovalsDiv = container.querySelector('.no-war-approvals');
            
            if (!listDiv || !noApprovalsDiv) return;

            if (needsApproval.length === 0) {
                listDiv.innerHTML = '';
                noApprovalsDiv.classList.remove('hidden');
                return;
            }
            
            noApprovalsDiv.classList.add('hidden');
            listDiv.innerHTML = needsApproval.map(doc => {
                const data = doc.data();
                const targets = data.targetCountries.map(t => t.country).join(', ');
                return `<div class="bg-gray-50 p-4 rounded-lg">
                    <p class="mb-2"><strong>War against:</strong> ${targets}</p>
                    ${data.justification ? `<p class="text-sm text-gray-600 mb-3">"${data.justification}"</p>` : ''}
                    <div class="flex gap-2">
                        <button onclick="approveWar('${doc.id}', true)" class="btn btn-success flex-1">Approve</button>
                        <button onclick="approveWar('${doc.id}', false)" class="btn btn-danger flex-1">Reject</button>
                    </div>
                </div>`;
            }).join('');
        }

        window.approveWar = async function(warId, approved) {
            const myRoles = getMyRoles();
            let approvalKey = '';
            if (myRoles.includes('Secretary of State')) {
                approvalKey = 'approvals.secretaryOfState';
            } else if (myRoles.includes('Minister of Domestic Tranquility')) {
                approvalKey = 'approvals.ministerOfDomestic';
            }
            if (!approvalKey) return;
            
            const warRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/pendingWars`, warId);
            await updateDoc(warRef, {
                [approvalKey]: approved
            });
            
            // Check if both have approved
            const warSnap = await getDoc(warRef);
            const approvals = warSnap.data().approvals;
            
            if (approvals.secretaryOfState === true && approvals.ministerOfDomestic === true) {
                // Move to active wars and notify enemies
                await declareWarFinalized(warId, warSnap.data());
            } else if (approved === false) {
                // Rejected - delete
                await deleteDoc(warRef);
                showInfoModal("Declaration Rejected", "<p>The war declaration has been rejected by a minister.</p>");
                await createLog(`A war declaration against ${warSnap.data().targetCountries.map(t=>t.country).join(', ')} was rejected.`);
            }
            
            await loadWarApprovals();
            await loadPendingWarDeclarations();
        };

        async function declareWarFinalized(warId, warData) {
            // Move to activeWars collection
            const activeWarRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/activeWars`, warId);
            await setDoc(activeWarRef, {
                ...warData,
                status: 'active',
                declaredAt: serverTimestamp()
            });
            
            // Notify all target countries
            for (const target of warData.targetCountries) {
                const notifCol = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${target.playerId}/notifications`);
                await addDoc(notifCol, {
                    type: 'war_declared',
                    from: warData.declaringCountry,
                    message: `⚔️ ${warData.declaringCountry} has declared WAR on your nation!`,
                    timestamp: serverTimestamp()
                });
            }
            
            // Delete pending war
            await deleteDoc(doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/pendingWars`, warId));
            
            showInfoModal("War Declared!", "<p>War has been officially declared. May fortune favor the bold!</p>");
            await createLog(`Our nation has officially declared war on ${warData.targetCountries.map(t=>t.country).join(', ')}.`);
        }
        
        // ==== Role Assignment System ====
        function maybeTriggerRoleAssignment() {
            if (isTeacher || !myCountryName || localGameState.round !== 1) return;
            if (roleAssignmentShown) return;
            
            const countryData = localCountryData[myCountryName];
            const rolesAssigned = countryData?.roleAssignments && 
                Object.keys(countryData.roleAssignments).length > 0;
            
            if (rolesAssigned) return;
            
            const teammates = Object.entries(localPlayersState)
                .filter(([id, player]) => player.country === myCountryName && !player.isTeacher)
                .map(([id, player]) => ({ id, email: player.email, name: player.name }));
            
            if (teammates.length === 0) return;
            
            teammates.sort((a, b) => a.email.localeCompare(b.email));
            const captain = teammates[0];
            
            if (userId !== captain.id) return;
            
            roleAssignmentShown = true;
            showRoleAssignmentModal(teammates);
        }

        function showRoleAssignmentModal(teammates) {
            const modal = document.getElementById('roleAssignmentModal');
            const countryNameEl = document.getElementById('roleAssignCountryName');
            const listEl = document.getElementById('roleAssignmentList');
            
            countryNameEl.innerHTML = `Round 1 setup: assign a role to each teammate on <span class="font-semibold">${myCountryName}</span>.`;
            
            listEl.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Note:</strong> If your team has fewer than ${STUDENT_ROLES.length} members, 
                        students can take multiple roles. Check multiple boxes per person.
                    </p>
                </div>
                ${teammates.map(teammate => `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <div class="font-semibold text-gray-800 mb-2">${teammate.name}</div>
                        <div class="text-sm text-gray-500 mb-3">${teammate.email}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${STUDENT_ROLES.map(role => `
                                <label class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" 
                                           value="${role.name}" 
                                           data-player-id="${teammate.id}" 
                                           data-email="${teammate.email}"
                                           class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-700">${role.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
            
            modal.classList.remove('hidden');
        }
        
        window.closeRoleAssignmentModal = function() {
            document.getElementById('roleAssignmentModal').classList.add('hidden');
            isTeacherEditingRoles = false; // Reset the flag
        }

        window.saveRoleAssignments = async function() {
            if (isTeacherEditingRoles) {
                // Teacher logic (using selects)
                const selects = document.querySelectorAll('#roleAssignmentList select');
                const assignments = {};

                selects.forEach(select => {
                    const email = select.dataset.email;
                    const role = select.value;
                    if (email) {
                        assignments[email] = role ? [role] : []; // Store as array, even if single or empty
                    }
                });

                try {
                    const batch = writeBatch(db);
                    const countryName = document.getElementById('teacherCountrySelect').value;
                    const countryRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/countryData`, countryName);
                    
                    const roleAssignmentsForDb = {};
                    Object.entries(assignments).forEach(([email, roles]) => {
                        roleAssignmentsForDb[email] = roles;
                    });
                    batch.set(countryRef, { roleAssignments: roleAssignmentsForDb }, { merge: true });

                    selects.forEach(select => {
                        const playerId = select.dataset.playerId;
                        const roles = assignments[select.dataset.email] || [];
                        if (playerId) {
                            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, playerId);
                            batch.update(playerRef, {
                                roles: roles,
                                role: roles[0] || null
                            });
                        }
                    });

                    await batch.commit();
                    closeRoleAssignmentModal();
                    showInfoModal("Roles Updated", `<p>Roles for ${countryName} have been updated.</p>`);
                } catch (error) {
                    console.error("Failed to save teacher role edits:", error);
                    showInfoModal("Save Failed", `<p>Could not save role edits: ${error.message}</p>`);
                }

            } else {
                // Original Student logic (using checkboxes)
                const checkboxes = document.querySelectorAll('#roleAssignmentList input[type="checkbox"]');
                if (checkboxes.length === 0 && !isTeacherEditingRoles) {
                    console.error('No checkboxes found in role assignment modal (student flow)');
                    showInfoModal("Save Failed", "<p>Role assignment UI not ready. Please try again.</p>");
                    return;
                }
                const assignments = {}; // email -> array of roles
                const roleCoverage = new Set(); // track which roles are assigned
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const email = checkbox.dataset.email;
                        const role = checkbox.value;
                        
                        if (!assignments[email]) {
                            assignments[email] = [];
                        }
                        assignments[email].push(role);
                        roleCoverage.add(role);
                    }
                });
                
                const teammates = [...new Set(Array.from(checkboxes).map(cb => cb.dataset.email))];
                const unassignedStudents = teammates.filter(email => !assignments[email] || assignments[email].length === 0);
                
                if (unassignedStudents.length > 0) {
                    showInfoModal("Unassigned Students", 
                        `<p>The following students have no roles assigned:</p>
                         <ul class="list-disc list-inside mt-2">
                             ${unassignedStudents.map(email => `<li>${email}</li>`).join('')}
                         </ul>
                         <p class="mt-2">Please assign at least one role to each student.</p>`);
                    return;
                }
                
                const criticalRoles = ['Secretary of the Treasury', 'Secretary of War', 'Secretary of State', 'Minister of Domestic Tranquility'];
                const missingCritical = criticalRoles.filter(role => !roleCoverage.has(role));
                
                if (missingCritical.length > 0) {
                    const body = `<p>Warning: The following important roles are not assigned:</p>
                                  <ul class="list-disc list-inside mt-2 text-left">${missingCritical.map(r => `<li>${r}</li>`).join('')}</ul>
                                  <p class="mt-2">These roles have key gameplay functions. Do you want to continue anyway?</p>`;
                    const proceed = await showConfirmModal("Missing Critical Roles", body);
                    if (!proceed) return;
                }
                
                try {
                    const batch = writeBatch(db);
                    
                    const countryRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/countryData`, myCountryName);
                    batch.set(countryRef, { roleAssignments: assignments }, { merge: true });
                    
                    Object.entries(assignments).forEach(([email, roles]) => {
                        const playerId = Array.from(checkboxes).find(cb => cb.dataset.email === email)?.dataset.playerId;
                        if (playerId) {
                            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, playerId);
                            batch.update(playerRef, { 
                                roles: roles,
                                role: roles[0] || null
                            });
                        }
                    });
                    
                    await batch.commit();
                    
                    closeRoleAssignmentModal();
                    showInfoModal("Roles Assigned", 
                        `<p>Team roles have been successfully assigned!</p>
                         <p class="text-sm text-gray-600 mt-2">Students with multiple roles will see all their role tabs.</p>`);
                    
                    setupStudentTabs();
                    
                } catch (error) {
                    console.error("Failed to save role assignments:", error);
                    showInfoModal("Save Failed", `<p>Could not save role assignments: ${error.message}</p>`);
                }
            }
        };

        window.showTeacherRoleEditor = async function() {
            isTeacherEditingRoles = true;
            const countries = [...new Set(Object.values(localPlayersState)
                .filter(p => !p.isTeacher)
                .map(p => p.country))];
            
            const modal = document.getElementById('roleAssignmentModal');
            const countryNameEl = document.getElementById('roleAssignCountryName');
            
            const countrySelect = `
                <div class="mb-4">
                    <label class="block font-medium text-gray-700 mb-2">Select Country to Edit:</label>
                    <select id="teacherCountrySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        ${countries.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </div>
            `;
            
            countryNameEl.innerHTML = countrySelect;
            
            if (countries.length > 0) {
                loadCountryRoles(countries[0]);
            }
            
            setTimeout(() => {
                document.getElementById('teacherCountrySelect').addEventListener('change', (e) => {
                    loadCountryRoles(e.target.value);
                });
            }, 100);
            
            modal.classList.remove('hidden');
        };

        function loadCountryRoles(countryName) {
            const countryData = localCountryData[countryName];
            const currentAssignments = countryData?.roleAssignments || {};

            const teammates = Object.entries(localPlayersState)
                .filter(([id, player]) => player.country === countryName && !player.isTeacher)
                .map(([id, player]) => ({ 
                    id, 
                    email: player.email, 
                    name: player.name, 
                    currentRoles: currentAssignments[player.email] || player.roles || [player.role] || []
                }));

            const listEl = document.getElementById('roleAssignmentList');
            listEl.innerHTML = teammates.map(teammate => {
                // For simplicity in the teacher editor, we'll assign one primary role.
                const primaryRole = teammate.currentRoles[0] || '';
                return `
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <div class="font-semibold text-gray-800">${teammate.name}</div>
                            <div class="text-sm text-gray-500">${teammate.email}</div>
                        </div>
                    </div>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                            data-player-id="${teammate.id}" data-email="${teammate.email}">
                        <option value="">-- No Role Assigned --</option>
                        ${STUDENT_ROLES.map(role => 
                            `<option value="${role.name}" ${role.name === primaryRole ? 'selected' : ''}>
                                ${role.name}
                            </option>`
                        ).join('')}
                    </select>
                </div>
            `}).join('');
        }


        function setupStudentTabsWithWar() {
            const myRoles = getMyRoles();
            const tabsContainer = document.getElementById('roleTabs');
            const contentContainer = document.getElementById('roleTabContent');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            
            if (myRoles.length === 0) {
                contentContainer.innerHTML = `<p class="text-gray-500">Your role has not been assigned yet. Please wait for your team captain.</p>`;
                document.getElementById('studentRoleInterface').classList.remove('hidden');
                return;
            }

            const relevantRoles = STUDENT_ROLES.filter(role => myRoles.includes(role.name));

            relevantRoles.forEach((role, index) => {
                const roleId = role.name.replace(/\s+/g, '-');
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-btn' + (index === 0 ? ' active' : '');
                tabButton.textContent = role.name;
                tabButton.dataset.target = roleId;
                tabButton.onclick = () => switchTab(roleId);
                tabsContainer.appendChild(tabButton);

                const tabPanel = document.createElement('div');
                tabPanel.id = roleId;
                tabPanel.className = 'tab-panel space-y-6' + (index === 0 ? ' active' : '');
                
                let templateId = role.contentId;
                if(role.name === 'Secretary of War' && localGameState.round >= 4) {
                    templateId = 'warDeclarationTemplate';
                }

                if (templateId) {
                    const tpl = document.getElementById(templateId);
                    if (tpl) tabPanel.innerHTML = tpl.innerHTML;
                } else if (role.description) {
                     tabPanel.innerHTML = `
                        <div class="card p-6 bg-gray-50">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${role.name}</h3>
                            <p class="text-gray-600">${role.description}</p>
                        </div>`;
                }

                // Inject war approval section
                if ((role.name === 'Secretary of State' || role.name === 'Minister of Domestic Tranquility') && localGameState.round >= 4) {
                    const warApprovalTemplate = document.getElementById('warApprovalTemplate');
                    const approvalSection = tabPanel.querySelector('#ministerWarApprovalSection, #allianceWarApprovalSection');
                    if (approvalSection && warApprovalTemplate) {
                        approvalSection.innerHTML = warApprovalTemplate.innerHTML;
                        approvalSection.classList.remove('hidden');
                    }
                }

                contentContainer.appendChild(tabPanel);
            });

            document.getElementById('studentRoleInterface').classList.remove('hidden');
            updateWarDeclarationVisibility();
        }

        // Compatibility wrapper used elsewhere in the code
        function setupStudentTabs() {
            setupStudentTabsWithWar();
        }

        function updateWarDeclarationVisibility() {
            const myRoles = getMyRoles();
            const warInterface = document.getElementById('warDeclarationInterface');
            const round = localGameState.round || 1;
            if (warInterface) {
                if (myRoles.includes('Secretary of War') && round >= 4) {
                    warInterface.classList.remove('hidden');
                } else {
                    warInterface.classList.add('hidden');
                }
            }
            loadPendingWarDeclarations().catch(console.error);
            loadWarApprovals().catch(console.error);
        }

        window.showWarDeclarationModal = function() {
            const modal = document.getElementById('warDeclarationModal');
            const enemyList = document.getElementById('enemyAlliancesList');

            // Get my alliance bloc
            const me = localPlayersState[userId] || {};
            const myAllies = Object.keys(me.alliances || {}).filter(id => me.alliances[id]);
            myAllies.push(userId);

            // Group enemies by alliance
            const enemyAlliances = {};
            Object.entries(localPlayersState).forEach(([id, player]) => {
                if (player.isTeacher || myAllies.includes(id)) return;
                const theirAllies = Object.keys(player.alliances || {}).filter(aid => player.alliances[aid]);
                theirAllies.push(id);
                const key = theirAllies.sort().join(',');
                if (!enemyAlliances[key]) enemyAlliances[key] = [];
                enemyAlliances[key].push(player);
            });

            // Render checkboxes
            enemyList.innerHTML = '';
            Object.entries(enemyAlliances).forEach(([key, countries], idx) => {
                const block = document.createElement('div');
                block.className = 'bg-gray-50 p-4 rounded-lg';
                block.innerHTML = `<h5 class="font-semibold text-gray-700 mb-2">Enemy Alliance ${idx + 1}</h5>`;
                
                countries.forEach(country => {
                    const playerId = Object.keys(localPlayersState).find(pid => localPlayersState[pid] === country);
                    block.innerHTML += `
                        <label class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" value="${country.country}" data-player-id="${playerId}" 
                                class="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500">
                            <span class="ml-3 text-gray-700 font-medium">${country.country} (${country.name})</span>
                            <span class="ml-auto text-sm text-gray-500">Army: ${country.army || 0}, Navy: ${country.navy || 0}</span>
                        </label>`;
                });
                enemyList.appendChild(block);
            });

            modal.classList.remove('hidden');
        };
        
        window.closeWarDeclarationModal = function() {
            document.getElementById('warDeclarationModal').classList.add('hidden');
        };
        function populateAllianceModal() {
            const container = document.getElementById('countryCheckboxes');
            const myData = localPlayersState[userId] || {};
            
            const otherPlayers = Object.entries(localPlayersState)
                .filter(([id, p]) => !p.isTeacher && p.country !== myCountryName);
            
            container.innerHTML = otherPlayers.map(([id, player]) => {
                const isAllied = myData.alliances && myData.alliances[id];
                const restricted = (ALLIANCE_RESTRICTIONS[myCountryName] || []).includes(player.country);
                
                return `
                    <label class="flex items-center p-2 rounded hover:bg-gray-50 ${restricted ? 'opacity-50' : ''}">
                        <input type="checkbox" value="${id}" ${isAllied ? 'checked' : ''} 
                               ${restricted ? 'disabled' : ''}
                               class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                        <span class="ml-2">${player.country} (${player.name})</span>
                        ${restricted ? '<span class="ml-auto text-xs text-red-600">Historical Rivals</span>' : ''}
                    </label>`;
            }).join('');
        }

        window.showAllianceModal = function() {
            populateAllianceModal();
            document.getElementById('allianceModal').classList.remove('hidden');
        };
        window.closeAllianceModal = function() {
            document.getElementById('allianceModal').classList.add('hidden');
        };

        // Submit declaration -> apps/{APP_ID}/simulations/{classCode}/pendingWars/{warId}
        window.submitWarDeclaration = async function() {
            const checked = document.querySelectorAll('#enemyAlliancesList input[type="checkbox"]:checked');
            const selected = Array.from(checked);
            if (selected.length === 0) {
                showInfoModal("No Targets Selected", "<p>Select at least one enemy nation.</p>");
                return;
            }

            const me = localPlayersState[userId] || {};
            const myAllies = Object.keys(me.alliances || {}).filter(id => me.alliances[id]);

            const targets = selected.map(cb => ({ country: cb.value, playerId: cb.dataset.playerId }));

            // Prevent declaring war on current allies
            const alliedTargets = targets.filter(t => myAllies.includes(t.playerId));
            if (alliedTargets.length > 0) {
                const names = alliedTargets.map(t => t.country).join(', ');
                showInfoModal("Allied Nations Selected", `<p>You cannot declare war on current allies: <strong>${names}</strong>. Break the alliance first.</p>`);
                return;
            }

            const justification = (document.getElementById('warJustification')?.value || '').trim();

            try {
                const warDeclaration = {
                    declaringCountry: myCountryName,
                    declaringPlayerId: userId,
                    targetCountries: targets,
                    justification: justification || 'No justification provided',
                    timestamp: serverTimestamp(),
                    approvals: {
                        secretaryOfState: false,
                        ministerOfDomestic: false
                    },
                    status: 'pending',
                    round: localGameState.round || 1
                };

                const warsCol = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/pendingWars`);
                const warRef = doc(warsCol);
                await setDoc(warRef, warDeclaration);

                await notifyApprovers(warRef.id, warDeclaration);

                closeWarDeclarationModal();
                showInfoModal("Submitted", "<p>Your declaration has been submitted for approval.</p>");
                await loadPendingWarDeclarations();
            } catch (e) {
                console.error('submitWarDeclaration failed:', e);
                showInfoModal("Error", `<p>${e?.message || 'Something went wrong.'}</p>`);
            }
        };

        window.purchaseUnits = async function(unitType, context) {
            const quantityEl = document.getElementById(`${unitType}Quantity-${context}`);
            const quantity = parseInt(quantityEl.value);
            if (isNaN(quantity) || quantity <= 0) {
                showInfoModal("Invalid Quantity", "<p>Please enter a valid number of units to purchase.</p>");
                return;
            }
            
            const cost = unitType === 'army' ? 750 : 1000;
            const totalCost = quantity * cost;

            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, userId);

            try {
                await runTransaction(db, async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    if (!playerDoc.exists()) {
                        throw "Player data not found!";
                    }
                    const playerData = playerDoc.data();
                    const militaryBudget = (playerData.dollars * (playerData.militaryBudgetPercentage / 100));
                    const remainingBudget = militaryBudget - (playerData.militarySpendingThisRound || 0);

                    if (totalCost > remainingBudget) {
                        throw `Not enough military funds. You have $${remainingBudget.toLocaleString()} left.`;
                    }

                    const newUnitCount = (playerData[unitType] || 0) + quantity;
                    const newSpending = (playerData.militarySpendingThisRound || 0) + totalCost;
                    
                    transaction.update(playerRef, {
                        [unitType]: newUnitCount,
                        militarySpendingThisRound: newSpending
                    });
                });
                showInfoModal("Purchase Successful", `<p>You have purchased ${quantity} ${unitType} unit(s).</p>`);
                createLog(`Purchased ${quantity} ${unitType} unit(s).`);
            } catch (error) {
                console.error("Purchase failed:", error);
                showInfoModal("Purchase Failed", `<p>${error.toString()}</p>`);
            }
        };

        window.setMilitaryBudget = async function(value) {
            const percentage = parseInt(value);
            document.getElementById('militaryBudgetPercentageDisplay').textContent = `${percentage}%`;
            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, userId);
            try {
                await updateDoc(playerRef, { militaryBudgetPercentage: percentage });
                 createLog(`Set military budget allocation to ${percentage}%.`);
            } catch(e) {
                console.error("Failed to set military budget", e);
            }
        };

        // Download CSV template
        window.downloadTemplate = function() {
            const csvContent = "Email,Country,Period\nstudent1@example.com,Tobermory,1\nstudent2@example.com,Metz,1";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "roster_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Upload and parse CSV
        window.uploadCSV = async function() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showInfoModal("No File Selected", "<p>Please select a CSV file to upload.</p>");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                    
                    // Skip header row
                    const dataLines = lines.slice(1);
                    
                    if (dataLines.length === 0) {
                        showInfoModal("Empty File", "<p>The CSV file contains no student data.</p>");
                        return;
                    }
                    
                    const batch = writeBatch(db);
                    let successCount = 0;
                    let errors = [];
                    
                    for (const line of dataLines) {
                        const parts = line.split(',').map(p => p.trim());
                        const email = parts[0];
                        const country = parts[1];
                        const period = parts[2] || '';
                        
                        if (!email || !country) {
                            errors.push(`Skipped invalid row: ${line}`);
                            continue;
                        }
                        
                        // Validate country
                        if (!STARTING_BUDGETS[country]) {
                            errors.push(`Invalid country "${country}" for ${email}`);
                            continue;
                        }
                        
                        const rosterRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/roster`, email);
                        batch.set(rosterRef, {
                            email: email,
                            country: country,
                            period: period,
                            addedAt: serverTimestamp()
                        });
                        successCount++;
                    }
                    
                    await batch.commit();
                    
                    let message = `<p>Successfully added ${successCount} student(s) to the roster.</p>`;
                    if (errors.length > 0) {
                        message += `<p class="mt-3 text-sm text-red-600">Errors:</p><ul class="text-xs list-disc list-inside">`;
                        errors.forEach(err => {
                            message += `<li>${err}</li>`;
                        });
                        message += `</ul>`;
                    }
                    
                    showInfoModal("CSV Upload Complete", message);
                    await loadExistingRoster();
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error("CSV parsing error:", error);
                    showInfoModal("Upload Failed", `<p>Failed to parse CSV: ${error.message}</p>`);
                }
            };
            
            reader.readAsText(file);
        };

        // Add single student to roster
        window.addStudentToRoster = async function() {
            const email = document.getElementById('studentEmail').value.trim();
            const country = document.getElementById('studentCountry').value;
            const period = document.getElementById('studentPeriod').value;
            
            if (!email) {
                showInfoModal("Missing Email", "<p>Please enter a student email address.</p>");
                return;
            }
            
            if (!country) {
                showInfoModal("Missing Country", "<p>Please select a country for this student.</p>");
                return;
            }
            
            if (!email.includes('@')) {
                showInfoModal("Invalid Email", "<p>Please enter a valid email address.</p>");
                return;
            }
            
            try {
                const rosterRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/roster`, email);
                await setDoc(rosterRef, {
                    email: email,
                    country: country,
                    period: period,
                    addedAt: serverTimestamp()
                });
                
                showInfoModal("Student Added", `<p>${email} has been added to ${country}.</p>`);
                
                // Clear inputs
                document.getElementById('studentEmail').value = '';
                document.getElementById('studentCountry').value = '';
                document.getElementById('studentPeriod').value = '';
                
                await loadExistingRoster();
                
            } catch (error) {
                console.error("Failed to add student:", error);
                showInfoModal("Error", `<p>Failed to add student: ${error.message}</p>`);
            }
        };

        // Remove selected students
        window.removeSelectedStudents = async function() {
            const checkboxes = document.querySelectorAll('#rosterList input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showInfoModal("No Selection", "<p>Please select students to remove.</p>");
                return;
            }
            
            const confirmed = await showConfirmModal(
                "Remove Students?",
                `<p>Remove ${checkboxes.length} student(s) from the roster?</p>`
            );
            
            if (!confirmed) return;
            
            try {
                const batch = writeBatch(db);
                
                checkboxes.forEach(checkbox => {
                    const email = checkbox.value;
                    const rosterRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/roster`, email);
                    batch.delete(rosterRef);
                });
                
                await batch.commit();
                showInfoModal("Students Removed", `<p>${checkboxes.length} student(s) removed from roster.</p>`);
                await loadExistingRoster();
                
            } catch (error) {
                console.error("Failed to remove students:", error);
                showInfoModal("Error", `<p>Failed to remove students: ${error.message}</p>`);
            }
        };

        // Start simulation with selected period
        window.startSimulationDirectly = async function() {
            const selectedPeriod = document.getElementById('classPeriodSelect').value;
            
            if (!selectedPeriod) {
                showInfoModal("No Period Selected", "<p>Please select a class period to start.</p>");
                return;
            }
            
            const confirmed = await showConfirmModal(
                "Start Simulation?",
                `<p>Start the simulation for Period ${selectedPeriod}?</p>
                 <p class="text-sm text-gray-600 mt-2">Students in this period will be initialized with their starting budgets and resources.</p>`
            );
            
            if (!confirmed) return;
            
            try {
                // Get all students in the selected period
                const rosterColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/roster`);
                const q = query(rosterColRef, where('period', '==', selectedPeriod));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showInfoModal("No Students", `<p>No students found in Period ${selectedPeriod}.</p>`);
                    return;
                }
                
                const batch = writeBatch(db);
                
                // Initialize each student
                snapshot.forEach(doc => {
                    const studentData = doc.data();
                    const country = studentData.country;
                    
                    // Note: We don't create player docs here - they're created when students join
                    // Just ensure the country data exists
                    const countryRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/countryData`, country);
                    batch.set(countryRef, {
                        pnp: 100,
                        roleAssignments: {}
                    }, { merge: true });
                });
                
                // Set the simulation as active for this period
                const gameDocRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}`);
                batch.set(gameDocRef, {
                    activePeriod: selectedPeriod,
                    round: 1,
                    phase: 'waiting'
                }, { merge: true });
                
                await batch.commit();
                
                // Hide roster screen, show game
                document.getElementById('rosterScreen').classList.add('hidden');
                document.getElementById('gameContainer').classList.remove('hidden');
                
                setupFirestoreListeners();
                
                showInfoModal("Simulation Started", 
                    `<p>Simulation started for Period ${selectedPeriod}!</p>
                     <p class="text-sm text-gray-600 mt-2">Students can now join using class code: <strong>${currentClassCode}</strong></p>`);
                
            } catch (error) {
                console.error("Failed to start simulation:", error);
                showInfoModal("Error", `<p>Failed to start simulation: ${error.message}</p>`);
            }
        };

        // Clear all roster entries
        window.clearAllRoster = async function() {
            const confirmed = await showConfirmModal(
                "Clear Entire Roster?",
                "<p class='text-red-600 font-semibold'>This will remove ALL students from the roster.</p><p class='mt-2'>This action cannot be undone.</p>"
            );
            
            if (!confirmed) return;
            
            // Double confirmation for destructive action
            const doubleConfirmed = await showConfirmModal(
                "Are You Absolutely Sure?",
                "<p>This will permanently delete all roster data.</p>"
            );
            
            if (!doubleConfirmed) return;
            
            try {
                const rosterColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/roster`);
                const snapshot = await getDocs(rosterColRef);
                
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                showInfoModal("Roster Cleared", "<p>All students have been removed from the roster.</p>");
                await loadExistingRoster();
                
            } catch (error) {
                console.error("Failed to clear roster:", error);
                showInfoModal("Error", `<p>Failed to clear roster: ${error.message}</p>`);
            }
        };
        window.planColonization = async function(key) {
            const territory = COLONIAL_TERRITORIES[key];
            const myData = localPlayersState[userId] || {};
            
            if ((myData.dollars || 0) < territory.cost) {
                showInfoModal("Insufficient Funds", `<p>You need $${territory.cost.toLocaleString()} to attempt this colonization.</p>`);
                return;
            }
            
            const confirmed = await showConfirmModal(
                "Plan Colonization?",
                `<p>Pay $${territory.cost.toLocaleString()} now to attempt colonizing ${territory.name}?</p>
                 <p class="text-sm text-gray-600 mt-2">Success is determined at end of round (50% chance)</p>`
            );
            
            if (!confirmed) return;
            
            const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, userId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    const player = playerDoc.data();
                    
                    if (player.dollars < territory.cost) {
                        throw "Insufficient funds!";
                    }
                    
                    transaction.update(playerRef, {
                        dollars: player.dollars - territory.cost,
                        [`colonialPlans.${key}`]: territory
                    });
                });
                
                showInfoModal("Colonization Planned", `<p>You have invested in attempting to colonize ${territory.name}. Results will be revealed at the end of the round.</p>`);
                await createLog(`Invested $${territory.cost.toLocaleString()} to attempt colonizing ${territory.name}.`);
            } catch (error) {
                showInfoModal("Failed", `<p>${error.toString()}</p>`);
            }
        };
        window.proposeAlliance = async function() {
            const checkboxes = document.querySelectorAll('#countryCheckboxes input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                showInfoModal("No Selection", "<p>Please select at least one country to ally with.</p>");
                return;
            }

            // For each selected target, create a notification in their notifications collection
            for (const targetId of selectedIds) {
                const notifCol = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${targetId}/notifications`);
                await addDoc(notifCol, {
                    type: 'alliance_request',
                    fromPlayerId: userId,
                    fromCountry: localPlayersState[userId]?.country || 'Unknown',
                    message: `${localPlayersState[userId]?.country || 'A nation'} has proposed an alliance with you.`,
                    timestamp: serverTimestamp()
                });
            }

            closeAllianceModal();
            showInfoModal("Proposals Sent", "<p>Alliance proposals have been sent to selected nations.</p>");
            await createLog(`Sent alliance proposals to ${selectedIds.length} nation(s).`);
        };

        window.acceptAllianceRequest = async function(notificationId, fromPlayerId) {
            // Set alliance flag on both players
            const myRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, userId);
            const otherRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, fromPlayerId);

            const batch = writeBatch(db);
            batch.update(myRef, { [`alliances.${fromPlayerId}`]: true });
            batch.update(otherRef, { [`alliances.${userId}`]: true });

            // Remove the notification
            const notifRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${userId}/notifications`, notificationId);
            batch.delete(notifRef);

            await batch.commit();

            closeStudentNotificationModal();
            showInfoModal("Alliance Formed", `<p>You are now allied with ${localPlayersState[fromPlayerId]?.country || 'a nation'}.</p>`);
            await createLog(`Accepted alliance with ${localPlayersState[fromPlayerId]?.country || fromPlayerId}.`);
        };

        window.rejectAllianceRequest = async function(notificationId, fromPlayerId) {
            const notifRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${userId}/notifications`, notificationId);
            await deleteDoc(notifRef);
            closeStudentNotificationModal();
            showInfoModal("Alliance Rejected", `<p>You rejected the alliance proposal from ${localPlayersState[fromPlayerId]?.country || fromPlayerId}.</p>`);
            await createLog(`Rejected alliance with ${localPlayersState[fromPlayerId]?.country || fromPlayerId}.`);
        };
        window.startRound = async function() {
            const timerMinutes = parseInt(document.getElementById('timerMinutes').value) || 15;
            const timerEnds = new Date(Date.now() + timerMinutes * 60000);
            
            const gameDocRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}`);
            await updateDoc(gameDocRef, {
                phase: 'active',
                timerEnds: timerEnds
            });
            
            // Reset military spending for all players
            const playersColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`);
            const snapshot = await getDocs(query(playersColRef, where("isTeacher", "==", false)));
            const batch = writeBatch(db);
            snapshot.docs.forEach(d => {
                batch.update(d.ref, { militarySpendingThisRound: 0 });
            });
            await batch.commit();
        };
        window.resolveColonialChance = async function() {
            showInfoModal("Processing...", "<p>Resolving colonial attempts...</p>");
            
            const playersColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`);
            const snapshot = await getDocs(query(playersColRef, where("isTeacher", "==", false)));
            
            const batch = writeBatch(db);
            let results = [];
            
            for (const playerDoc of snapshot.docs) {
                const player = playerDoc.data();
                const plans = player.colonialPlans || {};
                
                for (const [key, plan] of Object.entries(plans)) {
                    const territory = COLONIAL_TERRITORIES[key];
                    if (!territory) continue;
                    const roll = Math.random() * 100;
                    const success = roll < 50; // 50% chance
                    
                    if (success) {
                        batch.update(playerDoc.ref, {
                            [`colonies.${key}`]: territory,
                            [`colonialPlans.${key}`]: null,
                            income: (player.income || BASE_INCOME) + territory.income
                        });
                        results.push(`${player.country} successfully colonized ${territory.name}!`);
                        
                        const logColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${playerDoc.id}/log`);
                        const logDocRef = doc(logColRef);
                        batch.set(logDocRef, {
                            message: `Successfully colonized ${territory.name}! (+${territory.income} income)`,
                            timestamp: serverTimestamp()
                        });
                    } else {
                        batch.update(playerDoc.ref, {
                            [`colonialPlans.${key}`]: null
                        });
                        results.push(`${player.country} failed to colonize ${territory.name}.`);
                        
                        const logColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${playerDoc.id}/log`);
                        const logDocRef = doc(logColRef);
                        batch.set(logDocRef, {
                            message: `Failed to colonize ${territory.name}. Funds lost.`,
                            timestamp: serverTimestamp()
                        });
                    }
                }
            }
            
            await batch.commit();
            closeInfoModal();
            showInfoModal("Colonial Results", `<div class="space-y-2">${results.map(r => `<p>${r}</p>`).join('')}</div>`);
        };
        window.checkAlliances = async function() {
            showInfoModal("Checking Alliances", "<p>Validating all alliances for historical accuracy...</p>");
            
            const playersColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`);
            const snapshot = await getDocs(query(playersColRef, where("isTeacher", "==", false)));
            
            const batch = writeBatch(db);
            let violations = [];
            
            snapshot.docs.forEach(playerDoc => {
                const player = playerDoc.data();
                const allies = Object.keys(player.alliances || {}).filter(id => player.alliances[id]);
                
                allies.forEach(allyId => {
                    const ally = localPlayersState[allyId];
                    if (ally) {
                        const restricted = ALLIANCE_RESTRICTIONS[player.country] || [];
                        if (restricted.includes(ally.country)) {
                            violations.push(`${player.country} cannot ally with ${ally.country} (historical rivals)`);
                            batch.update(playerDoc.ref, {
                                [`alliances.${allyId}`]: false
                            });
                        }
                    }
                });
            });
            
            await batch.commit();
            closeInfoModal();
            
            if (violations.length > 0) {
                showInfoModal("Alliance Violations", 
                    `<div class="space-y-2">${violations.map(v => `<p class="text-red-600">${v}</p>`).join('')}</div>`);
            } else {
                showInfoModal("Alliances Valid", "<p>All alliances are historically acceptable.</p>");
            }
        };
        window.nextRound = async function() {
            const gameDocRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}`);
            const currentRound = localGameState.round || 1;
            await updateDoc(gameDocRef, {
                round: currentRound + 1,
                phase: 'waiting'
            });
            showInfoModal("Round Advanced", `<p>Now starting Round ${currentRound + 1}</p>`);
        };
        window.showStudentDemoModal = () => { alert('Show student demo clicked'); };
        window.exitStudentDemo = () => { alert('Exit demo clicked'); };
        window.showPnpPanel = function() {
            const select = document.getElementById('pnpCountry');
            select.innerHTML = '<option value="">-- Select a Country --</option>';
            Object.values(localPlayersState)
                .filter(p => !p.isTeacher)
                .forEach(p => {
                    select.innerHTML += `<option value="${p.country}">${p.country}</option>`;
                });
            document.getElementById('pnpPanel').classList.remove('hidden');
        };

        window.closePnpPanel = function() {
            document.getElementById('pnpPanel').classList.add('hidden');
        };

        window.handleReasonChange = function() {
            const dropdown = document.getElementById('pnpReasonDropdown');
            const reasonInput = document.getElementById('pnpReason');
            if (!dropdown || !reasonInput) return;
            if (dropdown.value === 'Custom') {
                reasonInput.value = '';
                reasonInput.focus();
            } else if (dropdown.value) {
                reasonInput.value = dropdown.value;
            }
        };

        window.awardPnpToCountry = async function() {
            const country = document.getElementById('pnpCountry').value;
            const amount = parseInt(document.getElementById('pnpAmount').value);
            const reason = document.getElementById('pnpReason').value;
            
            if (!country || !amount || !reason) {
                showInfoModal("Missing Info", "<p>Please fill all fields.</p>");
                return;
            }
            
            // Find all players in that country
            const countryPlayers = Object.entries(localPlayersState)
                .filter(([id, p]) => p.country === country && !p.isTeacher);
            
            const batch = writeBatch(db);
            
            for (const [playerId, player] of countryPlayers) {
                const playerRef = doc(db, `apps/${APP_ID}/simulations/${currentClassCode}/players`, playerId);
                batch.update(playerRef, {
                    pnp: (player.pnp || 100) + amount
                });
                
                const logColRef = collection(db, `apps/${APP_ID}/simulations/${currentClassCode}/players/${playerId}/log`);
                const logDocRef = doc(logColRef);
                batch.set(logDocRef, {
                    message: `PNP ${amount > 0 ? 'awarded' : 'deducted'}: ${amount} (${reason})`,
                    timestamp: serverTimestamp()
                });
            }
            
            await batch.commit();
            closePnpPanel();
            showInfoModal("Success", `<p>Adjusted PNP for ${country} by ${amount}.</p>`);
        };
        window.exportResults = async function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('The North - Game Results', 20, 20);
            doc.setFontSize(12);
            doc.text(`Class: ${currentClassCode}`, 20, 30);
            doc.text(`Round: ${localGameState.round || 1}`, 20, 40);
            
            // Get all players sorted by score
            const playersArray = Object.values(localPlayersState)
                .filter(p => !p.isTeacher)
                .map(p => {
                    const basePnp = (localCountryData[p.country]?.pnp || 100) + (p.pnp - 100);
                    const armyPnp = (p.army || 0) * 750;
                    const navyPnp = (p.navy || 0) * 1000;
                    const coloniesPnp = Object.values(p.colonies || {}).reduce((sum, c) => sum + (c.cost || 0), 0);
                    return {
                        country: p.country,
                        name: p.name,
                        score: basePnp + armyPnp + navyPnp + coloniesPnp,
                        army: p.army || 0,
                        navy: p.navy || 0,
                        dollars: p.dollars || 0
                    };
                })
                .sort((a, b) => b.score - a.score);
            
            // Create table
            const tableData = playersArray.map((p, i) => [
                i + 1,
                p.country,
                p.name,
                p.score.toLocaleString(),
                p.army,
                p.navy,
                '$' + p.dollars.toLocaleString()
            ]);
            
            doc.autoTable({
                head: [['Rank', 'Country', 'Player', 'Total PNP', 'Army', 'Navy', 'Budget']],
                body: tableData,
                startY: 50
            });
            
            doc.save(`the-north-results-${currentClassCode}-round-${localGameState.round || 1}.pdf`);
            showInfoModal("Export Complete", "<p>Results have been downloaded as PDF.</p>");
        };
        // Helper to delete all documents in a collection in chunks
        async function deleteCollection(colRef, chunkSize = 250) {
            const qSnap = await getDocs(colRef);
            const docs = qSnap.docs;
            for (let i = 0; i < docs.length; i += chunkSize) {
                const batch = writeBatch(db);
                for (const d of docs.slice(i, i + chunkSize)) batch.delete(d.ref);
                await batch.commit();
            }
        }

        window.resetGame = async function() {
            const confirmed = await showConfirmModal(
                "Reset Game?",
                "<p>This will delete ALL game data (players, roster, country data, wars, logs). This cannot be undone. Proceed?</p>"
            );
            if (!confirmed) return;

            const base = `apps/${APP_ID}/simulations/${currentClassCode}`;

            try {
                // Delete top-level subcollections
                await deleteCollection(collection(db, `${base}/players`));
                await deleteCollection(collection(db, `${base}/roster`));
                await deleteCollection(collection(db, `${base}/countryData`));
                await deleteCollection(collection(db, `${base}/warDeclarations`));
                // activeWars or other collections
                try { await deleteCollection(collection(db, `${base}/activeWars`)); } catch(e) {}

                // Clean nested per-player collections if any (logs/notifications)
                const playersSnap = await getDocs(collection(db, `${base}/players`));
                for (const p of playersSnap.docs) {
                    try { await deleteCollection(collection(db, `${base}/players/${p.id}/log`)); } catch(e) {}
                    try { await deleteCollection(collection(db, `${base}/players/${p.id}/notifications`)); } catch(e) {}
                }

                // Finally delete the game doc
                await deleteDoc(doc(db, `apps/${APP_ID}/simulations/${currentClassCode}`));
                window.location.reload();
            } catch (error) {
                console.error('Reset failed:', error);
                showInfoModal('Reset Failed', `<p>Could not reset game: ${error.message}</p>`);
            }
        };
        
    </script>
</body>
</html>
